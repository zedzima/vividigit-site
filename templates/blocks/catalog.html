<!-- Catalog Block (Services Grid with client-side filtering) -->
<section class="catalog-block">
    {% if data.title %}
    <div class="catalog-header">
        <span class="tag tag-accent">{{ data.tag | default(block_type) }}</span>
        <h1>{{ data.title }}</h1>
        {% if data.subtitle %}
        <p class="catalog-subtitle">{{ data.subtitle }}</p>
        {% endif %}
    </div>
    {% endif %}

    <div class="catalog-toolbar">
        <div class="catalog-count">
            <span id="resultsCount">0</span> services found
        </div>
        <div class="catalog-sort">
            <select id="sortBy" class="form-input">
                <option value="popular">Popular</option>
                <option value="rating">Highest Rated</option>
                <option value="name">A-Z</option>
            </select>
        </div>
    </div>

    <div class="catalog-grid" id="catalogGrid">
        <div class="catalog-loading">Loading services...</div>
    </div>
</section>

<style>
.catalog-block {
    padding: var(--space-lg) 0;
}

.catalog-header {
    margin-bottom: var(--space-xl);
}

.catalog-header h1 {
    margin-bottom: var(--space-sm);
}

.catalog-subtitle {
    color: var(--text-muted);
}

.catalog-toolbar {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: var(--space-lg);
    padding-bottom: var(--space-md);
    border-bottom: 1px solid var(--border);
}

.catalog-count {
    font-size: var(--font-size-ui);
    color: var(--text-muted);
}

.catalog-sort select {
    min-width: 180px;
}

.catalog-grid {
    display: grid;
    grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
    gap: var(--space-lg);
}

.catalog-loading,
.catalog-empty {
    grid-column: 1 / -1;
    text-align: center;
    padding: var(--space-2xl);
    color: var(--text-muted);
}

/* Service Card */
.service-card {
    display: flex;
    flex-direction: column;
    background: var(--bg-card);
    border: 1px solid var(--border);
    border-radius: var(--radius-lg);
    padding: var(--space-lg);
    text-decoration: none;
    transition: var(--transition);
}

.service-card:hover {
    transform: translateY(-4px);
    box-shadow: var(--shadow-lg);
    border-color: var(--accent);
}

.service-card-header {
    display: flex;
    justify-content: space-between;
    align-items: flex-start;
    gap: var(--space-sm);
    margin-bottom: var(--space-md);
}

.service-categories {
    display: flex;
    flex-wrap: wrap;
    gap: 6px;
}

.service-category {
    display: inline-block;
    padding: 4px 10px;
    font-size: var(--font-size-caption);
    font-weight: 600;
    text-transform: uppercase;
    letter-spacing: 0.03em;
    background: rgba(99, 102, 241, 0.15);
    border: 1px solid rgba(99, 102, 241, 0.3);
    border-radius: 4px;
    color: var(--accent);
}

.service-rating {
    display: flex;
    align-items: center;
    gap: 4px;
    font-size: var(--font-size-ui);
    color: #f59e0b;
    font-weight: 500;
    flex-shrink: 0;
}

.service-card h3 {
    color: var(--text-primary);
    font-size: var(--font-size-body);
    font-weight: 600;
    margin-bottom: var(--space-sm);
    line-height: 1.3;
}

.service-card p {
    color: var(--text-secondary);
    font-size: var(--font-size-ui);
    line-height: 1.6;
    flex: 1;
    margin-bottom: var(--space-md);
}

.service-industries {
    display: flex;
    flex-wrap: wrap;
    gap: 6px;
    margin-bottom: var(--space-md);
}

.service-industry {
    padding: 2px 8px;
    font-size: var(--font-size-caption);
    background: var(--bg-tertiary);
    border-radius: 4px;
    color: var(--text-muted);
}

.service-languages {
    display: flex;
    flex-wrap: wrap;
    gap: 4px;
    margin-bottom: var(--space-md);
}

.service-lang {
    padding: 2px 6px;
    font-size: 10px;
    font-weight: 600;
    text-transform: uppercase;
    letter-spacing: 0.03em;
    background: var(--bg-tertiary);
    border: 1px solid var(--border);
    border-radius: 3px;
    color: var(--text-muted);
}

.service-card-footer {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding-top: var(--space-md);
    border-top: 1px solid var(--border);
}

.service-price {
    font-weight: 600;
    color: var(--text-primary);
}

.service-cta {
    color: var(--accent);
    font-weight: 500;
    font-size: var(--font-size-ui);
}
</style>

<script>
(function() {
    const grid = document.getElementById('catalogGrid');
    const countEl = document.getElementById('resultsCount');
    const sortEl = document.getElementById('sortBy');

    let allServices = [];

    // Demo services data
    const mockServices = [
        {
            slug: "seo-audit",
            url: "/services/seo-audit",
            title: "SEO Audit & Strategy",
            description: "Comprehensive technical SEO audit with actionable recommendations.",
            categories: ["SEO"],
            industries: ["SaaS", "E-commerce"],
            languages: ["EN", "DE"],
            delivery: "one-time",
            price: 1500,
            rating: 4.9,
            orders: 340
        },
        {
            slug: "content-strategy",
            url: "/services/content-strategy",
            title: "Content Strategy",
            description: "Data-driven content plan aligned with your business goals.",
            categories: ["Content"],
            industries: ["SaaS", "Finance", "Healthcare"],
            languages: ["EN", "DE", "FR"],
            delivery: "one-time",
            price: 2000,
            rating: 4.8,
            orders: 215
        },
        {
            slug: "ai-optimisation",
            url: "/services/ai-optimisation",
            title: "AI Visibility Audit",
            description: "Optimize your content for AI-powered search and LLM citations.",
            categories: ["SEO", "AEO"],
            industries: ["SaaS", "E-commerce", "Finance"],
            languages: ["EN", "DE", "FR", "ES", "RU", "ZH"],
            delivery: "one-time",
            price: 2500,
            rating: 4.9,
            orders: 89
        },
        {
            slug: "ppc-setup",
            url: "/services/ppc-setup",
            title: "PPC Campaign Setup",
            description: "Launch optimized paid campaigns across Google Ads and social.",
            categories: ["PPC"],
            industries: ["E-commerce", "SaaS"],
            languages: ["EN"],
            delivery: "one-time",
            price: 1800,
            rating: 4.7,
            orders: 428
        },
        {
            slug: "localization",
            url: "/services/localization",
            title: "Website Localization",
            description: "Professional translation and cultural adaptation for global markets.",
            categories: ["Content", "Localization"],
            industries: ["SaaS", "E-commerce", "Travel"],
            languages: ["EN", "DE", "FR", "ES", "RU", "ZH"],
            delivery: "one-time",
            price: 2500,
            rating: 4.9,
            orders: 189
        },
        {
            slug: "analytics-setup",
            url: "/services/analytics-setup",
            title: "Analytics Setup",
            description: "GA4, GTM, and custom dashboards for complete data visibility.",
            categories: ["Analytics"],
            industries: ["SaaS", "E-commerce", "Finance"],
            languages: ["EN", "DE"],
            delivery: "one-time",
            price: 1200,
            rating: 4.8,
            orders: 267
        },
        {
            slug: "seo-ongoing",
            url: "/services/seo-ongoing",
            title: "Ongoing SEO Management",
            description: "Monthly SEO optimization, monitoring and reporting.",
            categories: ["SEO"],
            industries: ["SaaS", "E-commerce", "Finance"],
            languages: ["EN", "DE"],
            delivery: "ongoing",
            price: 2000,
            rating: 4.8,
            orders: 156
        },
        {
            slug: "content-ongoing",
            url: "/services/content-ongoing",
            title: "Content Retainer",
            description: "Monthly content creation and publication management.",
            categories: ["Content"],
            industries: ["SaaS", "Finance", "Healthcare"],
            languages: ["EN", "DE", "FR"],
            delivery: "ongoing",
            price: 3000,
            rating: 4.7,
            orders: 98
        }
    ];

    function renderCard(service) {
        const categories = (service.categories || [service.category]).filter(Boolean).map(c =>
            '<span class="service-category">' + c + '</span>'
        ).join('');

        const industries = (service.industries || []).slice(0, 3).map(i =>
            '<span class="service-industry">' + i + '</span>'
        ).join('');

        const languages = (service.languages || []).map(lang =>
            '<span class="service-lang">' + lang + '</span>'
        ).join('');

        return '\
            <a href="' + (service.url || '/services/' + service.slug) + '" class="service-card">\
                <div class="service-card-header">\
                    <div class="service-categories">' + categories + '</div>\
                    ' + (service.rating ? '<span class="service-rating">★ ' + service.rating + '</span>' : '') + '\
                </div>\
                <h3>' + service.title + '</h3>\
                <p>' + (service.description || '') + '</p>\
                ' + (industries ? '<div class="service-industries">' + industries + '</div>' : '') + '\
                ' + (languages ? '<div class="service-languages">' + languages + '</div>' : '') + '\
                <div class="service-card-footer">\
                    <span class="service-price">From $' + (service.price || 0).toLocaleString() + '</span>\
                    <span class="service-cta">View →</span>\
                </div>\
            </a>\
        ';
    }

    function renderGrid(services) {
        if (services.length === 0) {
            grid.innerHTML = '<div class="catalog-empty">No services match your criteria</div>';
        } else {
            grid.innerHTML = services.map(renderCard).join('');
        }
        countEl.textContent = services.length;
    }

    function sortServices(services, by) {
        var sorted = services.slice();
        switch (by) {
            case 'rating':
                sorted.sort(function(a, b) { return (b.rating || 0) - (a.rating || 0); });
                break;
            case 'name':
                sorted.sort(function(a, b) { return a.title.localeCompare(b.title); });
                break;
            case 'popular':
            default:
                sorted.sort(function(a, b) { return (b.orders || 0) - (a.orders || 0); });
        }
        return sorted;
    }

    function getCheckedValues(filterName) {
        var dropdown = document.querySelector('[data-filter="' + filterName + '"]');
        if (!dropdown) return [];
        var checked = dropdown.querySelectorAll('input[type="checkbox"]:checked');
        return Array.from(checked).map(function(cb) { return cb.value; });
    }

    function updateDropdownText(dropdown) {
        var checked = dropdown.querySelectorAll('input[type="checkbox"]:checked');
        var textEl = dropdown.querySelector('.filter-selected-text');
        var filterName = dropdown.dataset.filter;
        var allLabel = {
            'category': 'All Categories',
            'industry': 'All Industries',
            'language': 'All Languages',
            'delivery': 'All Types'
        };
        if (checked.length === 0) {
            textEl.textContent = allLabel[filterName] || 'All';
        } else if (checked.length === 1) {
            textEl.textContent = checked[0].nextElementSibling.textContent;
        } else {
            textEl.textContent = checked.length + ' selected';
        }
    }

    function applyFilters() {
        var filtered = allServices.slice();

        // Category filter (multi-select)
        var categories = getCheckedValues('category');
        if (categories.length > 0) {
            filtered = filtered.filter(function(s) {
                var serviceCats = s.categories || [s.category];
                return categories.some(function(c) {
                    return serviceCats.some(function(sc) { return sc === c; });
                });
            });
        }

        // Industry filter (multi-select)
        var industries = getCheckedValues('industry');
        if (industries.length > 0) {
            filtered = filtered.filter(function(s) {
                return industries.some(function(ind) {
                    return (s.industries || []).some(function(si) { return si === ind; });
                });
            });
        }

        // Language filter (multi-select)
        var languages = getCheckedValues('language');
        if (languages.length > 0) {
            filtered = filtered.filter(function(s) {
                return languages.some(function(lang) {
                    return (s.languages || []).some(function(sl) { return sl === lang; });
                });
            });
        }

        // Delivery filter (multi-select)
        var delivery = getCheckedValues('delivery');
        if (delivery.length > 0) {
            filtered = filtered.filter(function(s) {
                return delivery.some(function(d) { return s.delivery === d; });
            });
        }

        return sortServices(filtered, sortEl ? sortEl.value : 'popular');
    }

    function init() {
        // Try to load from JSON, fall back to mock
        fetch('/data/services.json')
            .then(function(res) { return res.ok ? res.json() : Promise.reject(); })
            .then(function(data) {
                allServices = mockServices.map(function(mock) {
                    var real = data.find(function(d) { return d.slug === mock.slug; });
                    return real ? Object.assign({}, mock, real) : mock;
                });
                data.forEach(function(item) {
                    if (!allServices.find(function(s) { return s.slug === item.slug; })) {
                        allServices.push(item);
                    }
                });
                renderGrid(applyFilters());
            })
            .catch(function() {
                allServices = mockServices;
                renderGrid(applyFilters());
            });

        // Sort change handler
        if (sortEl) {
            sortEl.addEventListener('change', function() {
                renderGrid(applyFilters());
            });
        }

        // Filter dropdown toggle
        document.querySelectorAll('.filter-dropdown-toggle').forEach(function(btn) {
            btn.addEventListener('click', function(e) {
                e.stopPropagation();
                var dropdown = btn.closest('.filter-dropdown');
                var wasOpen = dropdown.classList.contains('open');
                // Close all dropdowns
                document.querySelectorAll('.filter-dropdown').forEach(function(d) {
                    d.classList.remove('open');
                });
                // Toggle current
                if (!wasOpen) dropdown.classList.add('open');
            });
        });

        // Filter checkbox change
        document.querySelectorAll('.filter-dropdown input[type="checkbox"]').forEach(function(cb) {
            cb.addEventListener('change', function() {
                var dropdown = cb.closest('.filter-dropdown');
                updateDropdownText(dropdown);
                renderGrid(applyFilters());
            });
        });

        // Close dropdowns on outside click
        document.addEventListener('click', function(e) {
            if (!e.target.closest('.filter-dropdown')) {
                document.querySelectorAll('.filter-dropdown').forEach(function(d) {
                    d.classList.remove('open');
                });
            }
        });

        // Reset filters button
        var resetBtn = document.querySelector('.btn-reset-filters');
        if (resetBtn) {
            resetBtn.addEventListener('click', function() {
                document.querySelectorAll('.filter-dropdown input[type="checkbox"]').forEach(function(cb) {
                    cb.checked = false;
                });
                document.querySelectorAll('.filter-dropdown').forEach(function(dropdown) {
                    updateDropdownText(dropdown);
                });
                renderGrid(applyFilters());
            });
        }
    }

    if (document.readyState === 'loading') {
        document.addEventListener('DOMContentLoaded', init);
    } else {
        init();
    }
})();
</script>
