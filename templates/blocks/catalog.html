<!-- Universal Catalog Block: Filterable entity grid -->
{% set source = data.source | default('services') %}
{% set count_label = data.count_label | default('services found') %}

<section class="catalog-block" data-source="{{ source }}">
    {% if data.title %}
    <div class="catalog-header">
        <span class="tag tag-accent">{{ data.tag | default(block_type) }}</span>
        <h2>{{ data.title }}</h2>
        {% if data.subtitle %}<p class="catalog-subtitle">{{ data.subtitle }}</p>{% endif %}
    </div>
    {% endif %}

    <div class="catalog-toolbar">
        <div class="catalog-count">
            <span class="catalog-count-num">0</span> {{ count_label }}
        </div>
        <div class="catalog-sort">
            <select class="catalog-sort-select form-input"></select>
        </div>
    </div>

    <div class="catalog-grid">
        <div class="catalog-loading">Loading...</div>
    </div>
</section>

<script>
(function() {
    var section = document.currentScript.previousElementSibling;
    var source = section.dataset.source || 'services';
    var grid = section.querySelector('.catalog-grid');
    var countEl = section.querySelector('.catalog-count-num');
    var sortEl = section.querySelector('.catalog-sort-select');

    var allItems = [];

    /* ===== Source configs ===== */
    var SOURCES = {
        services: {
            url: 'data/services-index.json',
            dataKey: 'services',
            sortOptions: [['popular', 'Popular'], ['rating', 'Highest Rated'], ['name', 'A-Z']],
            filters: ['categories', 'industries', 'languages', 'countries', 'delivery']
        },
        team: {
            url: 'data/team.json',
            dataKey: 'specialists',
            sortOptions: [['rating', 'Highest Rated'], ['projects', 'Most Projects'], ['name', 'A-Z']],
            filters: ['languages', 'countries']
        },
        cases: {
            url: 'data/cases.json',
            dataKey: 'cases',
            sortOptions: [['default', 'Newest First'], ['name', 'A-Z']],
            filters: ['industry', 'services', 'country']
        },
        blog: {
            url: 'data/blog.json',
            dataKey: null,
            sortOptions: [['newest', 'Newest First'], ['oldest', 'Oldest First'], ['name', 'A-Z']],
            filters: ['category']
        },
        categories: {
            url: 'data/categories-index.json',
            dataKey: 'categories',
            sortOptions: [['default', 'Default'], ['name', 'A-Z'], ['services', 'Most Services']],
            filters: []
        },
        solutions: {
            url: 'data/solutions-index.json',
            dataKey: 'solutions',
            sortOptions: [['default', 'Default'], ['name', 'A-Z'], ['price', 'Lowest Price']],
            filters: ['service', 'industry']
        },
        industries: {
            url: 'data/industries-index.json',
            dataKey: 'industries',
            sortOptions: [['default', 'Default'], ['name', 'A-Z'], ['services', 'Most Services']],
            filters: []
        },
        countries: {
            url: 'data/countries-index.json',
            dataKey: 'countries',
            sortOptions: [['default', 'Default'], ['name', 'A-Z'], ['services', 'Most Services']],
            filters: []
        },
        languages: {
            url: 'data/languages-index.json',
            dataKey: 'languages',
            sortOptions: [['default', 'Default'], ['name', 'A-Z'], ['services', 'Most Services']],
            filters: []
        }
    };

    var cfg = SOURCES[source] || SOURCES.services;

    /* ===== Display maps ===== */
    var langCodeMap = { 'english': 'EN', 'german': 'DE', 'french': 'FR', 'spanish': 'ES', 'russian': 'RU', 'chinese': 'ZH', 'japanese': 'JA', 'italian': 'IT', 'portuguese': 'PT' };
    var categoryLabelMap = { 'digital-marketing': 'Digital Marketing', 'seo': 'SEO', 'aeo': 'AEO', 'content': 'Content', 'ppc': 'PPC', 'analytics': 'Analytics', 'social-media': 'Social Media', 'email': 'Email', 'cro': 'CRO', 'video': 'Video', 'pr': 'PR', 'automation': 'Automation', 'ecommerce': 'E-commerce', 'affiliate': 'Affiliate' };
    var industryLabelMap = { 'ecommerce': 'E-commerce', 'saas': 'SaaS', 'fintech': 'Fintech', 'healthcare': 'Healthcare', 'education': 'Education', 'realestate': 'Real Estate', 'travel': 'Travel' };
    var serviceLabelMap = { 'technical-seo': 'Technical SEO', 'ai-optimisation': 'AI Optimization', 'content-strategy': 'Content Strategy', 'ppc-management': 'PPC Management', 'analytics-setup': 'Analytics', 'localization': 'Localization' };
    var countryLabelMap = { 'germany': 'Germany', 'austria': 'Austria', 'usa': 'USA', 'uk': 'UK', 'france': 'France', 'spain': 'Spain' };
    var categoryIconMap = { 'seo': 'search', 'aeo': 'lightning', 'digital-marketing': 'globe', 'content': 'pen-tool', 'social-media': 'megaphone', 'ppc': 'target', 'email': 'mail', 'analytics': 'analytics', 'cro': 'chart', 'video': 'video', 'pr': 'newspaper', 'automation': 'code', 'ecommerce': 'layers', 'affiliate': 'users' };
    var avatarColors = [['#7C3AED','#C026D3'],['#2563EB','#06B6D4'],['#059669','#10B981'],['#D97706','#F59E0B'],['#DC2626','#F87171'],['#7C3AED','#6366F1']];

    function esc(str) { var d = document.createElement('div'); d.textContent = str || ''; return d.innerHTML; }
    function getInitials(name) { return (name || '').split(' ').map(function(w){return w[0]||'';}).join('').toUpperCase().slice(0,2); }

    /* ===== Card renderers ===== */
    function truncatedTags(arr, max, renderFn) {
        var shown = arr.slice(0, max);
        var html = shown.map(renderFn).join('');
        if (arr.length > max) html += renderFn('+' + (arr.length - max));
        return html;
    }

    function renderServiceCard(s) {
        var cats = (s.categories || []).map(function(c){ return '<span class="service-category">' + esc(categoryLabelMap[c] || c) + '</span>'; }).join('');
        var countries = (s.countries || []).map(function(c){ return '<span class="service-country">' + esc(countryLabelMap[c] || c) + '</span>'; }).join('');
        var langs = (s.languages || []).map(function(l){ return '<span class="service-lang">' + (langCodeMap[l] || l.toUpperCase().slice(0,2)) + '</span>'; }).join('');
        var specCount = s.specialist_count || 0;
        var url = (s.url || '/services/' + s.slug).replace(/^\//, '');
        return '<a href="' + url + '" class="service-card">' +
            '<div class="service-card-header"><div class="service-categories">' + cats + '</div>' +
            (specCount ? '<span class="service-spec-count">' + specCount + ' spec.</span>' : '') + '</div>' +
            '<h3>' + esc(s.title) + '</h3><p>' + esc(s.description) + '</p>' +
            (countries ? '<div class="service-countries">' + countries + '</div>' : '') +
            (langs ? '<div class="service-languages">' + langs + '</div>' : '') +
            '<div class="service-card-footer"><span class="service-price">From $' + (s.price || s.from_price || 0) + '</span><span class="service-cta">View →</span></div></a>';
    }

    function renderSpecialistCard(s) {
        var url = (s.url || '/team/' + s.slug).replace(/^\//, '');
        var initials = getInitials(s.title || s.slug);
        var avatarHtml = s.avatar
            ? '<div class="specialist-avatar"><img src="' + esc(s.avatar) + '" alt="' + esc(s.title) + '"></div>'
            : '<div class="specialist-avatar"><div class="specialist-avatar-initials">' + initials + '</div></div>';
        var langTags = (s.languages || []).map(function(l){ return '<span class="specialist-tag lang">' + (langCodeMap[l] || l.toUpperCase().slice(0,2)) + '</span>'; }).join('');
        var countryTags = (s.countries || []).map(function(c){ return '<span class="specialist-tag">' + esc(countryLabelMap[c] || c) + '</span>'; }).join('');
        return '<a href="' + url + '" class="specialist-card">' +
            '<div class="specialist-card-top">' + avatarHtml + '<div class="specialist-info"><h3>' + esc(s.title) + '</h3>' + (s.role ? '<div class="specialist-role">' + esc(s.role) + '</div>' : '') + '</div></div>' +
            '<div class="specialist-stats">' +
            (s.rating ? '<div class="specialist-stat"><span class="specialist-stat-value rating">★ ' + s.rating + '</span><span class="specialist-stat-label">Rating</span></div>' : '') +
            (s.projects ? '<div class="specialist-stat"><span class="specialist-stat-value">' + s.projects + '</span><span class="specialist-stat-label">Projects</span></div>' : '') +
            '</div>' +
            '<div class="specialist-tags">' +
            (langTags ? '<div class="specialist-tag-row">' + langTags + '</div>' : '') +
            (countryTags ? '<div class="specialist-tag-row">' + countryTags + '</div>' : '') +
            '</div>' +
            '<div class="specialist-card-footer">' +
            (s.hourly_rate ? '<span class="specialist-rate">$' + s.hourly_rate + '/h</span>' : '<span></span>') +
            '<span class="specialist-cta">View Profile →</span></div></a>';
    }

    function renderCaseCard(s) {
        var url = (s.url || '/cases/' + s.slug).replace(/^\//, '');
        var letter = (s.client || s.title || 'C').charAt(0).toUpperCase();
        var imageHtml = s.image
            ? '<div class="case-image"><img src="' + esc(s.image) + '" alt="' + esc(s.title) + '" loading="lazy"></div>'
            : '<div class="case-image"><div class="case-image-placeholder"><span>' + letter + '</span></div></div>';
        var resultsHtml = '';
        if (s.results && s.results.length > 0) {
            resultsHtml = '<div class="case-results">' + s.results.slice(0,2).map(function(r){ return '<div class="case-result"><span class="result-value">' + esc(r.value) + '</span><span class="result-label">' + esc(r.label) + '</span></div>'; }).join('') + '</div>';
        }
        var metaHtml = '';
        if (s.industry || s.client) {
            metaHtml = '<div class="case-meta">' +
                (s.industry ? '<span class="case-industry">' + esc(industryLabelMap[s.industry] || s.industry) + '</span>' : '') +
                (s.client ? '<span class="case-client">' + esc(s.client) + '</span>' : '') + '</div>';
        }
        return '<a href="' + url + '" class="case-card">' + imageHtml +
            '<div class="case-content">' + metaHtml +
            '<h3>' + esc(s.title) + '</h3><p>' + esc(s.description) + '</p>' +
            resultsHtml + '</div></a>';
    }

    function renderBlogCard(s) {
        var url = (s.url || '/blog/' + s.slug).replace(/^\//, '');
        if (url && url.slice(-1) !== '/') url += '/';
        return '<article class="blog-card">' +
            (s.category ? '<div class="blog-card-category">' + esc(s.category) + '</div>' : '') +
            '<h3 class="blog-card-title"><a href="' + url + '">' + esc(s.title) + '</a></h3>' +
            '<p class="blog-card-excerpt">' + esc(s.description) + '</p>' +
            '<div class="blog-card-meta">' + (s.date ? '<span>' + esc(s.date) + '</span>' : '') + (s.author ? '<span>by ' + esc(s.author) + '</span>' : '') + '</div></article>';
    }

    function renderCategoryCard(s) {
        var url = (s.url || '/categories/' + s.slug).replace(/^\//, '');
        var iconName = categoryIconMap[s.slug] || 'settings';
        var iconHtml = '<div class="category-card-icon" style="--icon-url: url(assets/icons/' + iconName + '.svg)"></div>';
        var price = s.door_opener_price ? 'From $' + s.door_opener_price : '';
        return '<a href="' + url + '" class="category-card">' +
            '<div class="category-card-header">' +
            '<h3>' + esc(s.menu || s.title) + '</h3>' +
            iconHtml + '</div>' +
            '<p>' + esc(s.description) + '</p>' +
            '<div class="category-card-footer">' +
            (price ? '<span class="category-price">' + price + '</span>' : '<span></span>') +
            '<span class="category-cta">Explore →</span></div></a>';
    }

    function renderSolutionCard(s) {
        var url = (s.url || '/solutions/' + s.slug).replace(/^\//, '');
        var tags = '';
        if (s.service) tags += '<span class="solution-tag">' + esc(serviceLabelMap[s.service] || s.service) + '</span>';
        if (s.industry) tags += '<span class="solution-tag industry">' + esc(industryLabelMap[s.industry] || s.industry) + '</span>';
        return '<a href="' + url + '" class="solution-card">' +
            (tags ? '<div class="solution-card-tags">' + tags + '</div>' : '') +
            '<h3>' + esc(s.title) + '</h3><p>' + esc(s.description) + '</p>' +
            '<div class="solution-card-footer">' +
            (s.starting_price ? '<span class="solution-price">From $' + s.starting_price + '</span>' : '<span></span>') +
            '<span class="solution-cta">View Solution →</span></div></a>';
    }

    function renderDimensionCard(s, collection) {
        var url = (s.url || '/' + collection + '/' + s.slug).replace(/^\//, '');
        var badgeHtml = '';
        if (s.icon) {
            badgeHtml = '<div class="dimension-card-badge icon" style="--icon-url: url(assets/icons/' + s.icon + '.svg)"></div>';
        } else if (s.flag) {
            badgeHtml = '<div class="dimension-card-badge">' + s.flag + '</div>';
        } else if (s.code) {
            badgeHtml = '<div class="dimension-card-badge code">' + esc(s.code) + '</div>';
        }
        var countText = s.service_count ? s.service_count + ' services' : '';
        return '<a href="' + url + '" class="dimension-card">' +
            '<div class="dimension-card-header">' +
            '<h3>' + esc(s.menu || s.title) + '</h3>' +
            badgeHtml + '</div>' +
            '<p>' + esc(s.description) + '</p>' +
            '<div class="dimension-card-footer">' +
            (countText ? '<span class="dimension-count">' + countText + '</span>' : '<span></span>') +
            '<span class="dimension-cta">Explore →</span></div></a>';
    }

    var RENDERERS = {
        services: renderServiceCard, team: renderSpecialistCard, cases: renderCaseCard, blog: renderBlogCard,
        categories: renderCategoryCard, solutions: renderSolutionCard,
        industries: function(s) { return renderDimensionCard(s, 'industries'); },
        countries: function(s) { return renderDimensionCard(s, 'countries'); },
        languages: function(s) { return renderDimensionCard(s, 'languages'); }
    };

    /* ===== Init sort dropdown ===== */
    cfg.sortOptions.forEach(function(opt) {
        var o = document.createElement('option');
        o.value = opt[0]; o.textContent = opt[1];
        sortEl.appendChild(o);
    });

    /* ===== Overflow trim for single-line tag rows ===== */
    function trimOverflowTags() {
        grid.querySelectorAll('.service-countries, .service-languages').forEach(function(row) {
            var children = Array.from(row.children);
            if (children.length <= 1 || row.scrollWidth <= row.clientWidth) return;
            var tagClass = children[0].className;
            var removed = 0;
            while (children.length > 0 && row.scrollWidth > row.clientWidth) {
                children.pop().remove();
                removed++;
            }
            if (removed > 0) {
                var more = document.createElement('span');
                more.className = tagClass;
                more.textContent = '+' + removed;
                more.style.flexShrink = '0';
                row.appendChild(more);
                while (row.children.length > 1 && row.scrollWidth > row.clientWidth) {
                    row.removeChild(row.children[row.children.length - 2]);
                    removed++;
                    more.textContent = '+' + removed;
                }
            }
        });
    }

    /* ===== Shared logic ===== */
    function renderGrid(items) {
        var render = RENDERERS[source] || RENDERERS.services;
        if (items.length === 0) {
            grid.innerHTML = '<div class="catalog-empty">No items match your criteria</div>';
        } else {
            grid.innerHTML = items.map(render).join('');
            trimOverflowTags();
        }
        countEl.textContent = items.length;
    }

    function getCheckedValues(filterName) {
        var dropdown = document.querySelector('[data-filter="' + filterName + '"]');
        if (!dropdown) return [];
        return Array.from(dropdown.querySelectorAll('input[type="checkbox"]:checked')).map(function(cb){ return cb.value; });
    }

    function updateDropdownText(dropdown) {
        var checked = dropdown.querySelectorAll('input[type="checkbox"]:checked');
        var textEl = dropdown.querySelector('.filter-selected-text');
        if (!textEl) return;
        if (checked.length === 0) textEl.textContent = textEl.dataset.all || 'All';
        else if (checked.length === 1) textEl.textContent = checked[0].nextElementSibling.textContent;
        else textEl.textContent = checked.length + ' selected';
    }

    function matchFilter(item, filterName) {
        var checked = getCheckedValues(filterName);
        if (checked.length === 0) return true;
        /* services source: tags are nested under item.tags or flat */
        var vals;
        if (source === 'services') {
            var tags = item.tags || {};
            vals = tags[filterName] || item[filterName] || [];
        } else if (source === 'cases' && filterName === 'industry') {
            return checked.indexOf(item.industry) !== -1;
        } else if (source === 'cases' && filterName === 'country') {
            return checked.indexOf(item.country) !== -1;
        } else if (source === 'solutions' && (filterName === 'service' || filterName === 'industry')) {
            return checked.indexOf(item[filterName] || '') !== -1;
        } else if (source === 'blog' && filterName === 'category') {
            return checked.some(function(c){ return (item.category || '').toLowerCase() === c.toLowerCase(); });
        } else {
            vals = item[filterName] || [];
        }
        if (!Array.isArray(vals)) vals = [vals];
        return checked.some(function(c){ return vals.indexOf(c) !== -1; });
    }

    function applyFilters() {
        var filtered = allItems.filter(function(item) {
            return cfg.filters.every(function(f){ return matchFilter(item, f); });
        });
        return sortItems(filtered, sortEl.value);
    }

    function sortItems(items, by) {
        var sorted = items.slice();
        switch (by) {
            case 'rating': sorted.sort(function(a,b){ return (b.rating||0)-(a.rating||0); }); break;
            case 'projects': sorted.sort(function(a,b){ return (b.projects||0)-(a.projects||0); }); break;
            case 'name': sorted.sort(function(a,b){ return (a.title||'').localeCompare(b.title||''); }); break;
            case 'newest': sorted.sort(function(a,b){ return (b.date||'').localeCompare(a.date||''); }); break;
            case 'oldest': sorted.sort(function(a,b){ return (a.date||'').localeCompare(b.date||''); }); break;
            case 'popular': sorted.sort(function(a,b){ return (b.rating||0)-(a.rating||0); }); break;
            case 'services': sorted.sort(function(a,b){ return (b.service_count||0)-(a.service_count||0); }); break;
            case 'price': sorted.sort(function(a,b){ return (a.starting_price||9999)-(b.starting_price||9999); }); break;
            default: break;
        }
        return sorted;
    }

    /* ===== Data normalization ===== */
    function normalizeServices(data) {
        return (data.services || []).filter(function(s){ return s.slug; }).map(function(s) {
            return { slug: s.slug, url: s.url, title: s.title, description: s.description,
                categories: (s.tags && s.tags.categories) || s.categories || [],
                industries: (s.tags && s.tags.industries) || s.industries || [],
                languages: (s.tags && s.tags.languages) || s.languages || [],
                countries: (s.tags && s.tags.countries) || s.countries || [],
                delivery: s.delivery || 'one-time',
                specialist_count: s.specialist_count || 0,
                rating: s.rating || 0, price: s.from_price || s.price || 0 };
        });
    }

    /* ===== Init ===== */
    function init() {
        fetch(cfg.url)
            .then(function(res) { return res.ok ? res.json() : Promise.reject(); })
            .then(function(data) {
                if (source === 'services') {
                    allItems = normalizeServices(data);
                } else {
                    allItems = cfg.dataKey ? (data[cfg.dataKey] || []) : (Array.isArray(data) ? data : []);
                }
                renderGrid(applyFilters());
            })
            .catch(function() {
                grid.innerHTML = '<div class="catalog-empty">Could not load data.</div>';
            });

        sortEl.addEventListener('change', function() { renderGrid(applyFilters()); });

        /* Sidebar filter interactions */
        document.querySelectorAll('.filter-dropdown-toggle').forEach(function(btn) {
            btn.addEventListener('click', function(e) {
                e.stopPropagation();
                var dd = btn.closest('.filter-dropdown');
                var wasOpen = dd.classList.contains('open');
                document.querySelectorAll('.filter-dropdown').forEach(function(d){ d.classList.remove('open'); });
                if (!wasOpen) dd.classList.add('open');
            });
        });
        /* Filter state: 'none' | 'pending' | 'applied' */
        var filterState = 'none';
        var filterBtn = document.querySelector('.btn-apply-filters');

        function updateFilterBtn() {
            if (!filterBtn) return;
            var anyChecked = !!document.querySelector('.filter-dropdown input[type="checkbox"]:checked');
            if (!anyChecked) {
                filterBtn.style.display = 'none';
            } else if (filterState === 'pending') {
                filterBtn.style.display = '';
                filterBtn.textContent = 'Apply Filters';
                filterBtn.className = 'btn btn-primary btn-full btn-apply-filters';
            } else {
                filterBtn.style.display = '';
                filterBtn.textContent = 'Reset Filters';
                filterBtn.className = 'btn btn-secondary btn-full btn-apply-filters';
            }
        }

        document.querySelectorAll('.filter-dropdown input[type="checkbox"]').forEach(function(cb) {
            cb.addEventListener('change', function() {
                updateDropdownText(cb.closest('.filter-dropdown'));
                var anyChecked = !!document.querySelector('.filter-dropdown input[type="checkbox"]:checked');
                if (anyChecked) {
                    filterState = 'pending';
                } else {
                    filterState = 'none';
                    renderGrid(applyFilters());
                }
                updateFilterBtn();
            });
        });
        document.addEventListener('click', function(e) {
            if (!e.target.closest('.filter-dropdown')) {
                document.querySelectorAll('.filter-dropdown').forEach(function(d){ d.classList.remove('open'); });
            }
        });
        if (filterBtn) {
            filterBtn.addEventListener('click', function() {
                if (filterState === 'pending') {
                    renderGrid(applyFilters());
                    filterState = 'applied';
                    window.dataLayer = window.dataLayer || [];
                    window.dataLayer.push({event: 'filter_apply'});
                } else if (filterState === 'applied') {
                    document.querySelectorAll('.filter-dropdown input[type="checkbox"]').forEach(function(cb){ cb.checked = false; });
                    document.querySelectorAll('.filter-dropdown').forEach(function(dd){ updateDropdownText(dd); });
                    renderGrid(applyFilters());
                    filterState = 'none';
                }
                updateFilterBtn();
            });
        }
    }

    if (document.readyState === 'loading') document.addEventListener('DOMContentLoaded', init);
    else init();
})();
</script>
