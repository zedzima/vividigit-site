<!-- Catalog Mini Block: Simplified entity grid with dimension filtering -->
{% set source = data.source | default('services') %}

<section class="catalog-mini-block"
    data-source="{{ source }}"
    data-dimension="{{ data.dimension | default('') }}"
    data-value="{{ data.value | default('') }}"
    data-limit="{{ data.limit | default(0) }}">

    {% if data.title %}
    <div class="catalog-mini-header">
        <span class="tag tag-accent">{{ data.tag | default(block_type) }}</span>
        <h2>{{ data.title }}</h2>
        {% if data.subtitle %}<p class="catalog-mini-subtitle">{{ data.subtitle }}</p>{% endif %}
    </div>
    {% endif %}

    <div class="catalog-mini-grid">
        <div class="catalog-mini-loading">Loading...</div>
    </div>
</section>

<script>
(function() {
    var section = document.currentScript.previousElementSibling;
    var source = section.dataset.source || 'services';
    var dimension = section.dataset.dimension || '';
    var value = section.dataset.value || '';
    var limit = parseInt(section.dataset.limit) || 0;
    var grid = section.querySelector('.catalog-mini-grid');

    /* ===== Source configs ===== */
    var SOURCES = {
        services:   { url: 'data/services-index.json', dataKey: 'services' },
        team:       { url: 'data/team.json', dataKey: 'specialists' },
        cases:      { url: 'data/cases.json', dataKey: 'cases' },
        blog:       { url: 'data/blog.json', dataKey: null },
        categories: { url: 'data/categories-index.json', dataKey: 'categories' },
        solutions:  { url: 'data/solutions-index.json', dataKey: 'solutions' },
        industries: { url: 'data/industries-index.json', dataKey: 'industries' },
        countries:  { url: 'data/countries-index.json', dataKey: 'countries' },
        languages:  { url: 'data/languages-index.json', dataKey: 'languages' }
    };

    var cfg = SOURCES[source] || SOURCES.services;

    /* ===== Display maps ===== */
    var langCodeMap = { 'english': 'EN', 'german': 'DE', 'french': 'FR', 'spanish': 'ES', 'russian': 'RU', 'chinese': 'ZH', 'japanese': 'JA', 'italian': 'IT', 'portuguese': 'PT' };
    var categoryLabelMap = { 'digital-marketing': 'Digital Marketing', 'seo': 'SEO', 'aeo': 'AEO', 'content': 'Content', 'ppc': 'PPC', 'analytics': 'Analytics', 'social-media': 'Social Media', 'email': 'Email', 'cro': 'CRO', 'video': 'Video', 'pr': 'PR', 'automation': 'Automation', 'ecommerce': 'E-commerce', 'affiliate': 'Affiliate' };
    var industryLabelMap = { 'ecommerce': 'E-commerce', 'saas': 'SaaS', 'fintech': 'Fintech', 'healthcare': 'Healthcare', 'education': 'Education', 'realestate': 'Real Estate', 'travel': 'Travel' };
    var serviceLabelMap = { 'technical-seo': 'Technical SEO', 'ai-optimisation': 'AI Optimization', 'content-strategy': 'Content Strategy', 'ppc-management': 'PPC Management', 'analytics-setup': 'Analytics', 'localization': 'Localization' };
    var countryLabelMap = { 'germany': 'Germany', 'austria': 'Austria', 'usa': 'USA', 'uk': 'UK', 'france': 'France', 'spain': 'Spain' };
    var categoryIconMap = { 'seo': 'search', 'aeo': 'lightning', 'digital-marketing': 'globe', 'content': 'pen-tool', 'social-media': 'megaphone', 'ppc': 'target', 'email': 'mail', 'analytics': 'analytics', 'cro': 'chart', 'video': 'video', 'pr': 'newspaper', 'automation': 'code', 'ecommerce': 'layers', 'affiliate': 'users' };
    var avatarColors = [['#7C3AED','#C026D3'],['#2563EB','#06B6D4'],['#059669','#10B981'],['#D97706','#F59E0B'],['#DC2626','#F87171'],['#7C3AED','#6366F1']];

    function esc(str) { var d = document.createElement('div'); d.textContent = str || ''; return d.innerHTML; }
    function getInitials(name) { return (name || '').split(' ').map(function(w){return w[0]||'';}).join('').toUpperCase().slice(0,2); }

    /* ===== Card renderers ===== */
    function truncatedTags(arr, max, renderFn) {
        var shown = arr.slice(0, max);
        var html = shown.map(renderFn).join('');
        if (arr.length > max) html += renderFn('+' + (arr.length - max));
        return html;
    }

    function renderServiceCard(s) {
        var cats = (s.categories || []).map(function(c){ return '<span class="service-category">' + esc(categoryLabelMap[c] || c) + '</span>'; }).join('');
        var countries = (s.countries || []).map(function(c){ return '<span class="service-country">' + esc(countryLabelMap[c] || c) + '</span>'; }).join('');
        var langs = (s.languages || []).map(function(l){ return '<span class="service-lang">' + (langCodeMap[l] || l.toUpperCase().slice(0,2)) + '</span>'; }).join('');
        var specCount = s.specialist_count || 0;
        var url = (s.url || '/services/' + s.slug).replace(/^\//, '');
        return '<a href="' + url + '" class="service-card">' +
            '<div class="service-card-header"><div class="service-categories">' + cats + '</div>' +
            (specCount ? '<span class="service-spec-count">' + specCount + ' spec.</span>' : '') + '</div>' +
            '<h3>' + esc(s.title) + '</h3><p>' + esc(s.description) + '</p>' +
            (countries ? '<div class="service-countries">' + countries + '</div>' : '') +
            (langs ? '<div class="service-languages">' + langs + '</div>' : '') +
            '<div class="service-card-footer"><span class="service-price">From $' + (s.price || s.from_price || 0) + '</span><span class="service-cta">View →</span></div></a>';
    }

    function renderSpecialistCard(s) {
        var url = (s.url || '/team/' + s.slug).replace(/^\//, '');
        var initials = getInitials(s.title || s.slug);
        var avatarHtml = s.avatar
            ? '<div class="specialist-avatar"><img src="' + esc(s.avatar) + '" alt="' + esc(s.title) + '"></div>'
            : '<div class="specialist-avatar"><div class="specialist-avatar-initials">' + initials + '</div></div>';
        var langTags = (s.languages || []).map(function(l){ return '<span class="specialist-tag lang">' + (langCodeMap[l] || l.toUpperCase().slice(0,2)) + '</span>'; }).join('');
        var countryTags = (s.countries || []).map(function(c){ return '<span class="specialist-tag">' + esc(countryLabelMap[c] || c) + '</span>'; }).join('');
        return '<a href="' + url + '" class="specialist-card">' +
            '<div class="specialist-card-top">' + avatarHtml + '<div class="specialist-info"><h3>' + esc(s.title) + '</h3>' + (s.role ? '<div class="specialist-role">' + esc(s.role) + '</div>' : '') + '</div></div>' +
            '<div class="specialist-stats">' +
            (s.rating ? '<div class="specialist-stat"><span class="specialist-stat-value rating">★ ' + s.rating + '</span><span class="specialist-stat-label">Rating</span></div>' : '') +
            (s.projects ? '<div class="specialist-stat"><span class="specialist-stat-value">' + s.projects + '</span><span class="specialist-stat-label">Projects</span></div>' : '') +
            '</div>' +
            '<div class="specialist-tags">' +
            (langTags ? '<div class="specialist-tag-row">' + langTags + '</div>' : '') +
            (countryTags ? '<div class="specialist-tag-row">' + countryTags + '</div>' : '') +
            '</div>' +
            '<div class="specialist-card-footer">' +
            (s.hourly_rate ? '<span class="specialist-rate">$' + s.hourly_rate + '/h</span>' : '<span></span>') +
            '<span class="specialist-cta">View Profile →</span></div></a>';
    }

    function renderCaseCard(s) {
        var url = (s.url || '/cases/' + s.slug).replace(/^\//, '');
        var letter = (s.client || s.title || 'C').charAt(0).toUpperCase();
        var imageHtml = s.image
            ? '<div class="case-image"><img src="' + esc(s.image) + '" alt="' + esc(s.title) + '" loading="lazy"></div>'
            : '<div class="case-image"><div class="case-image-placeholder"><span>' + letter + '</span></div></div>';
        var resultsHtml = '';
        if (s.results && s.results.length > 0) {
            resultsHtml = '<div class="case-results">' + s.results.slice(0,2).map(function(r){ return '<div class="case-result"><span class="result-value">' + esc(r.value) + '</span><span class="result-label">' + esc(r.label) + '</span></div>'; }).join('') + '</div>';
        }
        var metaHtml = '';
        if (s.industry || s.client) {
            metaHtml = '<div class="case-meta">' +
                (s.industry ? '<span class="case-industry">' + esc(industryLabelMap[s.industry] || s.industry) + '</span>' : '') +
                (s.client ? '<span class="case-client">' + esc(s.client) + '</span>' : '') + '</div>';
        }
        return '<a href="' + url + '" class="case-card">' + imageHtml +
            '<div class="case-content">' + metaHtml +
            '<h3>' + esc(s.title) + '</h3><p>' + esc(s.description) + '</p>' +
            resultsHtml + '</div></a>';
    }

    function renderBlogCard(s) {
        var url = (s.url || '/blog/' + s.slug).replace(/^\//, '');
        if (url && url.slice(-1) !== '/') url += '/';
        return '<article class="blog-card">' +
            (s.category ? '<div class="blog-card-category">' + esc(s.category) + '</div>' : '') +
            '<h3 class="blog-card-title"><a href="' + url + '">' + esc(s.title) + '</a></h3>' +
            '<p class="blog-card-excerpt">' + esc(s.description) + '</p>' +
            '<div class="blog-card-meta">' + (s.date ? '<span>' + esc(s.date) + '</span>' : '') + (s.author ? '<span>by ' + esc(s.author) + '</span>' : '') + '</div></article>';
    }

    function renderCategoryCard(s) {
        var url = (s.url || '/categories/' + s.slug).replace(/^\//, '');
        var iconName = categoryIconMap[s.slug] || 'settings';
        var iconHtml = '<div class="category-card-icon" style="--icon-url: url(/assets/icons/' + iconName + '.svg)"></div>';
        var price = s.door_opener_price ? 'From $' + s.door_opener_price : '';
        return '<a href="' + url + '" class="category-card">' +
            '<div class="category-card-header">' +
            '<h3>' + esc(s.menu || s.title) + '</h3>' +
            iconHtml + '</div>' +
            '<p>' + esc(s.description) + '</p>' +
            '<div class="category-card-footer">' +
            (price ? '<span class="category-price">' + price + '</span>' : '<span></span>') +
            '<span class="category-cta">Explore →</span></div></a>';
    }

    function renderSolutionCard(s) {
        var url = (s.url || '/solutions/' + s.slug).replace(/^\//, '');
        var tags = '';
        if (s.service) tags += '<span class="solution-tag">' + esc(serviceLabelMap[s.service] || s.service) + '</span>';
        if (s.industry) tags += '<span class="solution-tag industry">' + esc(industryLabelMap[s.industry] || s.industry) + '</span>';
        return '<a href="' + url + '" class="solution-card">' +
            (tags ? '<div class="solution-card-tags">' + tags + '</div>' : '') +
            '<h3>' + esc(s.title) + '</h3><p>' + esc(s.description) + '</p>' +
            '<div class="solution-card-footer">' +
            (s.starting_price ? '<span class="solution-price">From $' + s.starting_price + '</span>' : '<span></span>') +
            '<span class="solution-cta">View Solution →</span></div></a>';
    }

    function renderDimensionCard(s, collection) {
        var url = (s.url || '/' + collection + '/' + s.slug).replace(/^\//, '');
        var badgeHtml = '';
        if (s.icon) {
            badgeHtml = '<div class="dimension-card-badge icon" style="--icon-url: url(/assets/icons/' + s.icon + '.svg)"></div>';
        } else if (s.flag) {
            badgeHtml = '<div class="dimension-card-badge">' + s.flag + '</div>';
        } else if (s.code) {
            badgeHtml = '<div class="dimension-card-badge code">' + esc(s.code) + '</div>';
        }
        var countText = s.service_count ? s.service_count + ' services' : '';
        return '<a href="' + url + '" class="dimension-card">' +
            '<div class="dimension-card-header">' +
            '<h3>' + esc(s.menu || s.title) + '</h3>' +
            badgeHtml + '</div>' +
            '<p>' + esc(s.description) + '</p>' +
            '<div class="dimension-card-footer">' +
            (countText ? '<span class="dimension-count">' + countText + '</span>' : '<span></span>') +
            '<span class="dimension-cta">Explore →</span></div></a>';
    }

    var RENDERERS = {
        services: renderServiceCard,
        team: renderSpecialistCard,
        cases: renderCaseCard,
        blog: renderBlogCard,
        categories: renderCategoryCard,
        solutions: renderSolutionCard,
        industries: function(s) { return renderDimensionCard(s, 'industries'); },
        countries: function(s) { return renderDimensionCard(s, 'countries'); },
        languages: function(s) { return renderDimensionCard(s, 'languages'); }
    };

    /* ===== Overflow trim for single-line tag rows ===== */
    function trimOverflowTags() {
        grid.querySelectorAll('.service-countries, .service-languages').forEach(function(row) {
            var children = Array.from(row.children);
            if (children.length <= 1 || row.scrollWidth <= row.clientWidth) return;
            var tagClass = children[0].className;
            var removed = 0;
            while (children.length > 0 && row.scrollWidth > row.clientWidth) {
                children.pop().remove();
                removed++;
            }
            if (removed > 0) {
                var more = document.createElement('span');
                more.className = tagClass;
                more.textContent = '+' + removed;
                more.style.flexShrink = '0';
                row.appendChild(more);
                while (row.children.length > 1 && row.scrollWidth > row.clientWidth) {
                    row.removeChild(row.children[row.children.length - 2]);
                    removed++;
                    more.textContent = '+' + removed;
                }
            }
        });
    }

    /* ===== Filtering & rendering ===== */
    function filterByDimension(items) {
        if (!dimension || !value) return items;

        return items.filter(function(item) {
            /* For services: tags are nested under item.tags */
            if (source === 'services') {
                var tags = item.tags || {};
                var vals = tags[dimension] || item[dimension] || [];
                if (!Array.isArray(vals)) vals = [vals];
                return vals.indexOf(value) !== -1;
            }
            /* For cases: industry/country/language are scalars */
            if (source === 'cases' && (dimension === 'industry' || dimension === 'country' || dimension === 'language')) {
                return item[dimension] === value;
            }
            /* For solutions: service/industry are scalars */
            if (source === 'solutions' && (dimension === 'service' || dimension === 'industry')) {
                return item[dimension] === value;
            }
            /* For team, blog, etc: dimension is an array field */
            var fieldVals = item[dimension] || [];
            if (!Array.isArray(fieldVals)) fieldVals = [fieldVals];
            return fieldVals.indexOf(value) !== -1;
        });
    }

    function normalizeServices(data) {
        return (data.services || []).filter(function(s){ return s.slug; }).map(function(s) {
            return { slug: s.slug, url: s.url, title: s.title, description: s.description,
                tags: s.tags || {},
                categories: (s.tags && s.tags.categories) || s.categories || [],
                industries: (s.tags && s.tags.industries) || s.industries || [],
                languages: (s.tags && s.tags.languages) || s.languages || [],
                countries: (s.tags && s.tags.countries) || s.countries || [],
                specialist_count: s.specialist_count || 0,
                rating: s.rating || 0, price: s.from_price || s.price || 0 };
        });
    }

    function init() {
        fetch(cfg.url)
            .then(function(res) { return res.ok ? res.json() : Promise.reject(); })
            .then(function(data) {
                var items;
                if (source === 'services') {
                    items = normalizeServices(data);
                } else {
                    items = cfg.dataKey ? (data[cfg.dataKey] || []) : (Array.isArray(data) ? data : []);
                }

                items = filterByDimension(items);
                if (limit > 0) items = items.slice(0, limit);

                var render = RENDERERS[source] || RENDERERS.services;
                if (items.length === 0) {
                    grid.innerHTML = '<div class="catalog-mini-empty">No items found</div>';
                } else {
                    grid.innerHTML = items.map(render).join('');
                    trimOverflowTags();
                }
            })
            .catch(function() {
                grid.innerHTML = '<div class="catalog-mini-empty">Could not load data.</div>';
            });
    }

    if (document.readyState === 'loading') document.addEventListener('DOMContentLoaded', init);
    else init();
})();
</script>
