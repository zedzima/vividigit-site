<!-- Catalog Mini Block: Simplified entity grid with dimension filtering -->
{% set source = data.source | default('services') %}

<section class="catalog-mini-block"
    data-source="{{ source }}"
    data-dimension="{{ data.dimension | default('') }}"
    data-value="{{ data.value | default('') }}"
    data-limit="{{ data.limit | default(0) }}">

    {% if data.title %}
    <div class="catalog-mini-header">
        <span class="tag tag-accent">{{ data.tag | default(block_type) }}</span>
        <h2>{{ data.title }}</h2>
        {% if data.subtitle %}<p class="catalog-mini-subtitle">{{ data.subtitle }}</p>{% endif %}
    </div>
    {% endif %}

    <div class="catalog-mini-grid">
        <div class="catalog-mini-loading">Loading...</div>
    </div>
</section>

<script>
(function() {
    var section = document.currentScript.previousElementSibling;
    var source = section.dataset.source || 'services';
    var dimension = section.dataset.dimension || '';
    var value = section.dataset.value || '';
    var limit = parseInt(section.dataset.limit) || 0;
    var grid = section.querySelector('.catalog-mini-grid');

    /* ===== Source configs ===== */
    var SOURCES = {
        services:   { url: 'data/services-index.json', dataKey: 'services' },
        team:       { url: 'data/team.json', dataKey: 'specialists' },
        cases:      { url: 'data/cases.json', dataKey: 'cases' },
        blog:       { url: 'data/blog.json', dataKey: null },
        categories: { url: 'data/categories-index.json', dataKey: 'categories' },
        solutions:  { url: 'data/solutions-index.json', dataKey: 'solutions' },
        industries: { url: 'data/industries-index.json', dataKey: 'industries' },
        countries:  { url: 'data/countries-index.json', dataKey: 'countries' },
        languages:  { url: 'data/languages-index.json', dataKey: 'languages' }
    };

    var cfg = SOURCES[source] || SOURCES.services;

    /* ===== Display maps ===== */
    var langCodeMap = { 'english': 'EN', 'german': 'DE', 'french': 'FR', 'spanish': 'ES', 'russian': 'RU', 'chinese': 'ZH', 'japanese': 'JA', 'italian': 'IT', 'portuguese': 'PT' };
    var categoryLabelMap = { 'digital-marketing': 'Digital Marketing', 'seo': 'SEO', 'aeo': 'AEO', 'content': 'Content', 'ppc': 'PPC', 'analytics': 'Analytics', 'social-media': 'Social Media', 'email': 'Email', 'cro': 'CRO', 'video': 'Video', 'pr': 'PR', 'automation': 'Automation', 'ecommerce': 'E-commerce', 'affiliate': 'Affiliate' };
    var industryLabelMap = { 'ecommerce': 'E-commerce', 'saas': 'SaaS', 'fintech': 'Fintech', 'healthcare': 'Healthcare', 'education': 'Education', 'realestate': 'Real Estate', 'travel': 'Travel' };
    var serviceLabelMap = { 'technical-seo': 'Technical SEO', 'ai-optimisation': 'AI Optimization', 'content-strategy': 'Content Strategy', 'ppc-management': 'PPC Management', 'analytics-setup': 'Analytics', 'localization': 'Localization' };
    var countryLabelMap = { 'germany': 'Germany', 'austria': 'Austria', 'usa': 'USA', 'uk': 'UK', 'france': 'France', 'spain': 'Spain' };
    var categoryIconMap = { 'seo': 'search', 'aeo': 'lightning', 'digital-marketing': 'globe', 'content': 'pen-tool', 'social-media': 'megaphone', 'ppc': 'target', 'email': 'mail', 'analytics': 'analytics', 'cro': 'chart', 'video': 'video', 'pr': 'newspaper', 'automation': 'code', 'ecommerce': 'layers', 'affiliate': 'users' };

    function esc(str) { var d = document.createElement('div'); d.textContent = str || ''; return d.innerHTML; }
    function toTitleCase(text) {
        return String(text || '')
            .replace(/[-_]+/g, ' ')
            .replace(/\b\w/g, function(ch) { return ch.toUpperCase(); });
    }
    function formatAuthorName(author) {
        if (!author) return '';
        return toTitleCase(author);
    }
    function formatDate(value) {
        if (!value) return '';
        var d = new Date(value);
        if (isNaN(d.getTime())) return String(value);
        return d.toLocaleDateString('en-US', { year: 'numeric', month: 'short', day: 'numeric' });
    }
    function pluralize(count, singular, plural) {
        return count + ' ' + (count === 1 ? singular : plural);
    }
    function formatCurrency(value) {
        var n = Number(value);
        if (!isFinite(n) || n <= 0) return '';
        return '$' + Math.round(n).toLocaleString();
    }
    function resolveLabel(map, slug) {
        if (!slug) return '';
        return map[slug] || toTitleCase(slug);
    }

    /* ===== Card renderers ===== */
    function renderServiceCard(s) {
        var cats = (s.categories || []).map(function(c){ return '<span class="service-category">' + esc(resolveLabel(categoryLabelMap, c)) + '</span>'; }).join('');
        var industryCount = Number(s.industry_count || (s.industries || []).length || 0);
        var countryCount = Number(s.country_count || (s.countries || []).length || 0);
        var languageCount = Number(s.language_count || (s.languages || []).length || 0);
        var taskCount = Number(s.task_count || 0);
        var metrics = [];
        if (industryCount > 0) metrics.push('<span class="service-metric">' + esc(pluralize(industryCount, 'industry', 'industries')) + '</span>');
        if (countryCount > 0) metrics.push('<span class="service-metric">' + esc(pluralize(countryCount, 'country', 'countries')) + '</span>');
        if (languageCount > 0) metrics.push('<span class="service-metric">' + esc(pluralize(languageCount, 'language', 'languages')) + '</span>');
        if (taskCount > 0) metrics.push('<span class="service-metric">' + esc(pluralize(taskCount, 'task', 'tasks')) + '</span>');
        var delivery = s.delivery ? toTitleCase(String(s.delivery).replace('-', ' ')) : '';
        var price = formatCurrency(s.price || s.from_price);
        var url = (s.url || '/services/' + s.slug).replace(/^\//, '');
        return '<a href="' + url + '" class="service-card">' +
            '<div class="service-card-header"><div class="service-categories">' + cats + '</div>' +
            (delivery ? '<span class="service-spec-count">' + esc(delivery) + '</span>' : '') + '</div>' +
            '<h3>' + esc(s.menu || s.title) + '</h3><p>' + esc(s.description) + '</p>' +
            (metrics.length ? '<div class="service-card-meta">' + metrics.join('') + '</div>' : '') +
            '<div class="service-card-footer">' + (price ? '<span class="service-price">From ' + price + '</span>' : '<span></span>') + '<span class="service-cta">View Service →</span></div></a>';
    }

    function renderSpecialistCard(s) {
        return window.CMSCards.renderSpecialistCard(s, {
            langCodeMap: langCodeMap,
            countryLabel: countryLabelMap,
            industryLabel: industryLabelMap
        });
    }

    function renderCaseCard(s) {
        var url = (s.url || '/cases/' + s.slug).replace(/^\//, '');
        var title = s.menu || s.title;
        var letter = (s.client || title || 'C').charAt(0).toUpperCase();
        var imageHtml = s.image
            ? '<div class="case-image"><img src="' + esc(s.image) + '" alt="' + esc(title) + '" loading="lazy"></div>'
            : '<div class="case-image"><div class="case-image-placeholder"><span>' + letter + '</span></div></div>';
        var metaHtml = '';
        var scope = [];
        if (s.industry) scope.push('<span class="case-industry">' + esc(resolveLabel(industryLabelMap, s.industry)) + '</span>');
        if (s.country) scope.push('<span class="case-industry">' + esc(resolveLabel(countryLabelMap, s.country)) + '</span>');
        if (s.language) scope.push('<span class="case-industry">' + esc(langCodeMap[s.language] || s.language.toUpperCase().slice(0, 2)) + '</span>');
        if (scope.length || s.client) {
            metaHtml = '<div class="case-meta">' +
                scope.join('') +
                (s.client ? '<span class="case-client">' + esc(s.client) + '</span>' : '') + '</div>';
        }
        var primary = s.primary_result || ((s.results || [])[0] || null);
        var timeline = s.timeline || null;
        if (timeline && primary && timeline.value === primary.value && timeline.label === primary.label) {
            timeline = null;
        }
        var resultParts = [];
        if (primary) resultParts.push('<div class="case-result"><span class="result-value">' + esc(primary.value) + '</span><span class="result-label">' + esc(primary.label) + '</span></div>');
        if (timeline) resultParts.push('<div class="case-result"><span class="result-value">' + esc(timeline.value) + '</span><span class="result-label">' + esc(timeline.label) + '</span></div>');
        var resultsHtml = resultParts.length ? '<div class="case-results">' + resultParts.join('') + '</div>' : '';
        return '<a href="' + url + '" class="case-card">' + imageHtml +
            '<div class="case-content">' + metaHtml +
            '<h3>' + esc(title) + '</h3><p>' + esc(s.description) + '</p>' +
            resultsHtml + '</div></a>';
    }

    function renderBlogCard(s) {
        var url = (s.url || '/blog/' + s.slug).replace(/^\//, '');
        if (url && url.slice(-1) !== '/') url += '/';
        var chips = [];
        if (s.type) chips.push('<span class="blog-chip">' + esc(toTitleCase(s.type)) + '</span>');
        if (s.category) chips.push('<span class="blog-chip">' + esc(s.category) + '</span>');
        var dateLabel = formatDate(s.date);
        var authorLabel = formatAuthorName(s.author);
        return '<article class="blog-card">' +
            (chips.length ? '<div class="blog-card-tags">' + chips.join('') + '</div>' : '') +
            '<h3 class="blog-card-title"><a href="' + url + '">' + esc(s.title) + '</a></h3>' +
            '<p class="blog-card-excerpt">' + esc(s.description) + '</p>' +
            '<div class="blog-card-meta">' + (dateLabel ? '<span>' + esc(dateLabel) + '</span>' : '') + (authorLabel ? '<span>By ' + esc(authorLabel) + '</span>' : '') + '</div></article>';
    }

    function renderCategoryCard(s) {
        var url = (s.url || '/categories/' + s.slug).replace(/^\//, '');
        var iconName = categoryIconMap[s.slug] || 'settings';
        var iconHtml = '<div class="category-card-icon" style="--icon-url: url(/assets/icons/' + iconName + '.svg)"></div>';
        var price = formatCurrency(s.door_opener_price);
        var metrics = [];
        if (s.service_count) metrics.push('<span class="category-meta-item">' + esc(pluralize(s.service_count, 'service', 'services')) + '</span>');
        if (s.specialist_count) metrics.push('<span class="category-meta-item">' + esc(pluralize(s.specialist_count, 'specialist', 'specialists')) + '</span>');
        if (s.industry_count) metrics.push('<span class="category-meta-item">' + esc(pluralize(s.industry_count, 'industry', 'industries')) + '</span>');
        if (s.country_count) metrics.push('<span class="category-meta-item">' + esc(pluralize(s.country_count, 'country', 'countries')) + '</span>');
        if (s.language_count) metrics.push('<span class="category-meta-item">' + esc(pluralize(s.language_count, 'language', 'languages')) + '</span>');
        return '<a href="' + url + '" class="category-card">' +
            '<div class="category-card-header">' +
            '<h3>' + esc(s.menu || s.title) + '</h3>' +
            iconHtml + '</div>' +
            '<p>' + esc(s.description) + '</p>' +
            (metrics.length ? '<div class="category-card-meta">' + metrics.join('') + '</div>' : '') +
            '<div class="category-card-footer">' +
            (price ? '<span class="category-price">From ' + price + '</span>' : '<span></span>') +
            '<span class="category-cta">Explore →</span></div></a>';
    }

    function renderSolutionCard(s) {
        var url = (s.url || '/solutions/' + s.slug).replace(/^\//, '');
        var f = s.facets || {};
        var tags = '';
        if (s.service) tags += '<span class="solution-tag">' + esc(resolveLabel(serviceLabelMap, s.service)) + '</span>';
        if (s.industry) tags += '<span class="solution-tag industry">' + esc(resolveLabel(industryLabelMap, s.industry)) + '</span>';
        var metrics = [];
        var specialistCount = Number(s.specialist_count || (f.specialists || []).length || 0);
        var caseCount = Number(s.case_count || (f.cases || []).length || 0);
        var countryCount = (f.countries || []).length;
        var languageCount = (f.languages || []).length;
        if (specialistCount > 0) metrics.push('<span class="solution-meta-item">' + esc(pluralize(specialistCount, 'specialist', 'specialists')) + '</span>');
        if (caseCount > 0) metrics.push('<span class="solution-meta-item">' + esc(pluralize(caseCount, 'case', 'cases')) + '</span>');
        if (countryCount > 0) metrics.push('<span class="solution-meta-item">' + esc(pluralize(countryCount, 'country', 'countries')) + '</span>');
        if (languageCount > 0) metrics.push('<span class="solution-meta-item">' + esc(pluralize(languageCount, 'language', 'languages')) + '</span>');
        var price = formatCurrency(s.starting_price);
        return '<a href="' + url + '" class="solution-card">' +
            (tags ? '<div class="solution-card-tags">' + tags + '</div>' : '') +
            '<h3>' + esc(s.menu || s.title) + '</h3><p>' + esc(s.description) + '</p>' +
            (metrics.length ? '<div class="solution-card-meta">' + metrics.join('') + '</div>' : '') +
            '<div class="solution-card-footer">' +
            (price ? '<span class="solution-price">From ' + price + '</span>' : '<span></span>') +
            '<span class="solution-cta">View Solution →</span></div></a>';
    }

    function renderDimensionCard(s, collection) {
        var url = (s.url || '/' + collection + '/' + s.slug).replace(/^\//, '');
        var badgeHtml = '';
        if (s.icon) {
            badgeHtml = '<div class="dimension-card-badge icon" style="--icon-url: url(/assets/icons/' + s.icon + '.svg)"></div>';
        } else if (s.flag) {
            badgeHtml = '<div class="dimension-card-badge">' + s.flag + '</div>';
        } else if (s.code) {
            badgeHtml = '<div class="dimension-card-badge code">' + esc(s.code) + '</div>';
        }
        var meta = [];
        if (collection === 'languages') {
            if (s.native_speakers_l1) meta.push('<span class="dimension-stat">Global native speakers: ' + esc(s.native_speakers_l1) + '</span>');
            if (s.official_countries_count) meta.push('<span class="dimension-stat">Official country footprint: ' + s.official_countries_count + '</span>');
        } else if (collection === 'countries') {
            if (s.population_total) meta.push('<span class="dimension-stat">Market population: ' + esc(s.population_total) + '</span>');
            if (s.official_languages_count) meta.push('<span class="dimension-stat">Official language coverage: ' + s.official_languages_count + '</span>');
        }
        var metaHtml = meta.length ? '<div class="dimension-card-meta">' + meta.join('') + '</div>' : '';
        var countText = s.service_count ? s.service_count + ' services' : '';
        return '<a href="' + url + '" class="dimension-card">' +
            '<div class="dimension-card-header">' +
            '<h3>' + esc(s.menu || s.title) + '</h3>' +
            badgeHtml + '</div>' +
            '<p>' + esc(s.description) + '</p>' +
            metaHtml +
            '<div class="dimension-card-footer">' +
            (countText ? '<span class="dimension-count">' + countText + '</span>' : '<span></span>') +
            '<span class="dimension-cta">Explore →</span></div></a>';
    }

    var RENDERERS = {
        services: renderServiceCard,
        team: renderSpecialistCard,
        cases: renderCaseCard,
        blog: renderBlogCard,
        categories: renderCategoryCard,
        solutions: renderSolutionCard,
        industries: function(s) { return renderDimensionCard(s, 'industries'); },
        countries: function(s) { return renderDimensionCard(s, 'countries'); },
        languages: function(s) { return renderDimensionCard(s, 'languages'); }
    };

    /* ===== Overflow trim for single-line tag rows ===== */
    function trimOverflowTags() {
        grid.querySelectorAll('.service-countries, .service-languages').forEach(function(row) {
            var children = Array.from(row.children);
            if (children.length <= 1 || row.scrollWidth <= row.clientWidth) return;
            var tagClass = children[0].className;
            var removed = 0;
            while (children.length > 0 && row.scrollWidth > row.clientWidth) {
                children.pop().remove();
                removed++;
            }
            if (removed > 0) {
                var more = document.createElement('span');
                more.className = tagClass;
                more.textContent = '+' + removed;
                more.style.flexShrink = '0';
                row.appendChild(more);
                while (row.children.length > 1 && row.scrollWidth > row.clientWidth) {
                    row.removeChild(row.children[row.children.length - 2]);
                    removed++;
                    more.textContent = '+' + removed;
                }
            }
        });
    }

    /* ===== Filtering & rendering ===== */
    function filterByDimension(items) {
        if (!dimension || !value) return items;

        return items.filter(function(item) {
            /* For services: tags are nested under item.tags */
            if (source === 'services') {
                var tags = item.tags || {};
                var vals = tags[dimension] || item[dimension] || [];
                if (!Array.isArray(vals)) vals = [vals];
                return vals.indexOf(value) !== -1;
            }
            /* For cases: industry/country/language are scalars */
            if (source === 'cases' && (dimension === 'industry' || dimension === 'country' || dimension === 'language')) {
                return item[dimension] === value;
            }
            /* For solutions: service/industry are scalars */
            if (source === 'solutions' && (dimension === 'service' || dimension === 'industry')) {
                return item[dimension] === value;
            }
            /* For team, blog, etc: dimension is an array field */
            var fieldVals = item[dimension] || [];
            if (!Array.isArray(fieldVals)) fieldVals = [fieldVals];
            return fieldVals.indexOf(value) !== -1;
        });
    }

    function normalizeServices(data) {
        return (data.services || []).filter(function(s){ return s.slug; }).map(function(s) {
            var facets = s.facets || {};
            return {
                slug: s.slug,
                url: s.url,
                title: s.title,
                menu: s.menu,
                description: s.description,
                facets: facets,
                categories: facets.categories || s.categories || [],
                industries: facets.industries || s.industries || [],
                languages: facets.languages || s.languages || [],
                countries: facets.countries || s.countries || [],
                specialist_count: s.specialist_count || 0,
                industry_count: s.industry_count || 0,
                country_count: s.country_count || 0,
                language_count: s.language_count || 0,
                task_count: s.task_count || 0,
                delivery: s.delivery || '',
                rating: s.rating || 0,
                price: s.from_price || s.price || 0,
                from_price: s.from_price || s.price || 0
            };
        });
    }

    function init() {
        fetch(cfg.url)
            .then(function(res) { return res.ok ? res.json() : Promise.reject(); })
            .then(function(data) {
                var items;
                if (source === 'services') {
                    items = normalizeServices(data);
                } else {
                    items = cfg.dataKey ? (data[cfg.dataKey] || []) : (Array.isArray(data) ? data : []);
                }

                items = filterByDimension(items);
                if (limit > 0) items = items.slice(0, limit);

                var render = RENDERERS[source] || RENDERERS.services;
                if (items.length === 0) {
                    grid.innerHTML = '<div class="catalog-mini-empty">No items found</div>';
                } else {
                    grid.innerHTML = items.map(render).join('');
                    trimOverflowTags();
                }
            })
            .catch(function() {
                grid.innerHTML = '<div class="catalog-mini-empty">Could not load data.</div>';
            });
    }

    if (document.readyState === 'loading') document.addEventListener('DOMContentLoaded', init);
    else init();
})();
</script>
