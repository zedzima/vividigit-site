<!-- Universal Catalog Block: Filterable entity grid -->
{% set source = data.source | default('services') %}
{% set count_label = data.count_label | default('services found') %}

<section class="catalog-block" data-source="{{ source }}">
    {% if data.title %}
    <div class="catalog-header">
        <span class="tag tag-accent">{{ data.tag | default(block_type) }}</span>
        <h2>{{ data.title }}</h2>
        {% if data.subtitle %}<p class="catalog-subtitle">{{ data.subtitle }}</p>{% endif %}
    </div>
    {% endif %}

    {% if data.filters %}
    <div class="catalog-filters">
        {% for filter in data.filters %}
        <div class="filter-dropdown" data-filter="{{ filter.name }}"{% if filter.match %} data-match="{{ filter.match }}"{% endif %}>
            <button class="filter-dropdown-toggle" type="button">
                <span class="filter-selected-text" data-all="{{ filter.all_label }}">{{ filter.all_label }}</span>
                <svg class="dropdown-arrow" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <polyline points="6 9 12 15 18 9"></polyline>
                </svg>
            </button>
            <div class="filter-dropdown-menu">
                {% for option in filter.options %}
                <label class="filter-option"><input type="checkbox" value="{{ option.value }}"><span class="filter-option-label">{{ option.label }}</span></label>
                {% endfor %}
            </div>
        </div>
        {% endfor %}
        <button class="btn btn-primary btn-sm btn-apply-filters hidden">Apply Filters</button>
    </div>
    {% endif %}

    <div class="catalog-toolbar">
        <div class="catalog-count">
            <span class="catalog-count-num">0</span> {{ count_label }}
        </div>
        <div class="catalog-sort">
            <select class="catalog-sort-select form-input"></select>
        </div>
    </div>

    <div class="catalog-grid">
        <div class="catalog-loading">Loading...</div>
    </div>
</section>

<script>
(function() {
    var section = document.currentScript.previousElementSibling;
    var source = section.dataset.source || 'services';
    var grid = section.querySelector('.catalog-grid');
    var countEl = section.querySelector('.catalog-count-num');
    var sortEl = section.querySelector('.catalog-sort-select');

    var allItems = [];
    var LABELS = {};

    /* ===== Source configs ===== */
    var SOURCES = {
        services: {
            url: 'data/services-index.json',
            dataKey: 'services',
            sortOptions: [['popular', 'Popular'], ['rating', 'Highest Rated'], ['name', 'A-Z']]
        },
        team: {
            url: 'data/team.json',
            dataKey: 'specialists',
            sortOptions: [['projects', 'Most Projects'], ['name', 'A-Z']]
        },
        cases: {
            url: 'data/cases.json',
            dataKey: 'cases',
            sortOptions: [['default', 'Newest First'], ['name', 'A-Z']]
        },
        blog: {
            url: 'data/blog.json',
            dataKey: null,
            sortOptions: [['newest', 'Newest First'], ['oldest', 'Oldest First'], ['name', 'A-Z']]
        },
        categories: {
            url: 'data/categories-index.json',
            dataKey: 'categories',
            sortOptions: [['default', 'Default'], ['name', 'A-Z'], ['services', 'Most Services']]
        },
        solutions: {
            url: 'data/solutions-index.json',
            dataKey: 'solutions',
            sortOptions: [['default', 'Default'], ['name', 'A-Z'], ['price', 'Lowest Price']]
        },
        industries: {
            url: 'data/industries-index.json',
            dataKey: 'industries',
            sortOptions: [['default', 'Default'], ['name', 'A-Z'], ['services', 'Most Services']]
        },
        countries: {
            url: 'data/countries-index.json',
            dataKey: 'countries',
            sortOptions: [['default', 'Default'], ['name', 'A-Z'], ['services', 'Most Services']]
        },
        languages: {
            url: 'data/languages-index.json',
            dataKey: 'languages',
            sortOptions: [['default', 'Default'], ['name', 'A-Z'], ['services', 'Most Services']]
        }
    };

    var cfg = SOURCES[source] || SOURCES.services;

    /* Auto-detect filters from DOM */
    var filterEls = section.querySelectorAll('[data-filter]');
    var activeFilters = Array.from(filterEls).map(function(el) { return el.dataset.filter; });

    /* ===== Display maps (visual-only, not data) ===== */
    var langCodeMap = { 'english': 'EN', 'german': 'DE', 'french': 'FR', 'spanish': 'ES', 'russian': 'RU', 'chinese': 'ZH', 'japanese': 'JA', 'italian': 'IT', 'portuguese': 'PT' };
    var categoryIconMap = { 'seo': 'search', 'aeo': 'lightning', 'digital-marketing': 'globe', 'content': 'pen-tool', 'social-media': 'megaphone', 'ppc': 'target', 'email': 'mail', 'analytics': 'analytics', 'cro': 'chart', 'video': 'video', 'pr': 'newspaper', 'automation': 'code', 'marketplace-management': 'layers', 'affiliate': 'users' };

    function label(dimension, slug) {
        return (LABELS[dimension] || {})[slug] || slug;
    }

    function esc(str) { var d = document.createElement('div'); d.textContent = str || ''; return d.innerHTML; }
    function toTitleCase(text) {
        return String(text || '')
            .replace(/[-_]+/g, ' ')
            .replace(/\b\w/g, function(ch) { return ch.toUpperCase(); });
    }
    function formatAuthorName(author) {
        if (!author) return '';
        return toTitleCase(author);
    }
    function formatDate(value) {
        if (!value) return '';
        var d = new Date(value);
        if (isNaN(d.getTime())) return String(value);
        return d.toLocaleDateString('en-US', { year: 'numeric', month: 'short', day: 'numeric' });
    }
    function pluralize(count, singular, plural) {
        return count + ' ' + (count === 1 ? singular : plural);
    }
    function formatCurrency(value) {
        var n = Number(value);
        if (!isFinite(n) || n <= 0) return '';
        return '$' + Math.round(n).toLocaleString();
    }

    /* ===== Card renderers ===== */
    function renderServiceCard(s) {
        var f = s.facets || {};
        var cats = (f.categories || []).map(function(c){ return '<span class="service-category">' + esc(label('categories', c)) + '</span>'; }).join('');
        var industryCount = Number(s.industry_count || (f.industries || []).length || 0);
        var countryCount = Number(s.country_count || (f.countries || []).length || 0);
        var languageCount = Number(s.language_count || (f.languages || []).length || 0);
        var taskCount = Number(s.task_count || 0);
        var metrics = [];
        if (industryCount > 0) metrics.push('<span class="service-metric">' + esc(pluralize(industryCount, 'industry', 'industries')) + '</span>');
        if (countryCount > 0) metrics.push('<span class="service-metric">' + esc(pluralize(countryCount, 'country', 'countries')) + '</span>');
        if (languageCount > 0) metrics.push('<span class="service-metric">' + esc(pluralize(languageCount, 'language', 'languages')) + '</span>');
        if (taskCount > 0) metrics.push('<span class="service-metric">' + esc(pluralize(taskCount, 'task', 'tasks')) + '</span>');
        var delivery = s.delivery ? toTitleCase(String(s.delivery).replace('-', ' ')) : '';
        var price = formatCurrency(s.price || s.from_price);
        var url = (s.url || '/services/' + s.slug).replace(/^\//, '');
        return '<a href="' + url + '" class="service-card">' +
            '<div class="service-card-header"><div class="service-categories">' + cats + '</div>' +
            (delivery ? '<span class="service-spec-count">' + esc(delivery) + '</span>' : '') + '</div>' +
            '<h3>' + esc(s.menu || s.title) + '</h3><p>' + esc(s.description) + '</p>' +
            (metrics.length ? '<div class="service-card-meta">' + metrics.join('') + '</div>' : '') +
            '<div class="service-card-footer">' + (price ? '<span class="service-price">From ' + price + '</span>' : '<span></span>') + '<span class="service-cta">View Service →</span></div></a>';
    }

    function renderSpecialistCard(s) {
        return window.CMSCards.renderSpecialistCard(s, {
            langCodeMap: langCodeMap,
            countryLabel: function(slug) { return label('countries', slug); },
            industryLabel: function(slug) { return label('industries', slug); }
        });
    }

    function renderCaseCard(s) {
        var url = (s.url || '/cases/' + s.slug).replace(/^\//, '');
        var title = s.menu || s.title;
        var letter = (s.client || title || 'C').charAt(0).toUpperCase();
        var imageHtml = s.image
            ? '<div class="case-image"><img src="' + esc(s.image) + '" alt="' + esc(title) + '" loading="lazy"></div>'
            : '<div class="case-image"><div class="case-image-placeholder"><span>' + letter + '</span></div></div>';
        var metaHtml = '';
        var scope = [];
        if (s.industry) scope.push('<span class="case-industry">' + esc(label('industries', s.industry)) + '</span>');
        if (s.country) scope.push('<span class="case-industry">' + esc(label('countries', s.country)) + '</span>');
        if (s.language) scope.push('<span class="case-industry">' + esc(langCodeMap[s.language] || (label('languages', s.language) || s.language).slice(0, 2).toUpperCase()) + '</span>');
        if (scope.length || s.client) {
            metaHtml = '<div class="case-meta">' +
                scope.join('') +
                (s.client ? '<span class="case-client">' + esc(s.client) + '</span>' : '') + '</div>';
        }
        var primary = s.primary_result || ((s.results || [])[0] || null);
        var timeline = s.timeline || null;
        if (timeline && primary && timeline.value === primary.value && timeline.label === primary.label) {
            timeline = null;
        }
        var resultParts = [];
        if (primary) resultParts.push('<div class="case-result"><span class="result-value">' + esc(primary.value) + '</span><span class="result-label">' + esc(primary.label) + '</span></div>');
        if (timeline) resultParts.push('<div class="case-result"><span class="result-value">' + esc(timeline.value) + '</span><span class="result-label">' + esc(timeline.label) + '</span></div>');
        var resultsHtml = resultParts.length ? '<div class="case-results">' + resultParts.join('') + '</div>' : '';
        return '<a href="' + url + '" class="case-card">' + imageHtml +
            '<div class="case-content">' + metaHtml +
            '<h3>' + esc(title) + '</h3><p>' + esc(s.description) + '</p>' +
            resultsHtml + '</div></a>';
    }

    function renderBlogCard(s) {
        var url = (s.url || '/blog/' + s.slug).replace(/^\//, '');
        if (url && url.slice(-1) !== '/') url += '/';
        var chips = [];
        if (s.type) chips.push('<span class="blog-chip">' + esc(toTitleCase(s.type)) + '</span>');
        if (s.category) chips.push('<span class="blog-chip">' + esc(s.category) + '</span>');
        var dateLabel = formatDate(s.date);
        var authorLabel = formatAuthorName(s.author);
        return '<article class="blog-card">' +
            (chips.length ? '<div class="blog-card-tags">' + chips.join('') + '</div>' : '') +
            '<h3 class="blog-card-title"><a href="' + url + '">' + esc(s.title) + '</a></h3>' +
            '<p class="blog-card-excerpt">' + esc(s.description) + '</p>' +
            '<div class="blog-card-meta">' + (dateLabel ? '<span>' + esc(dateLabel) + '</span>' : '') + (authorLabel ? '<span>By ' + esc(authorLabel) + '</span>' : '') + '</div></article>';
    }

    function renderCategoryCard(s) {
        var url = (s.url || '/categories/' + s.slug).replace(/^\//, '');
        var iconName = categoryIconMap[s.slug] || 'settings';
        var iconHtml = '<div class="category-card-icon" style="--icon-url: url(/assets/icons/' + iconName + '.svg)"></div>';
        var price = formatCurrency(s.door_opener_price);
        var metrics = [];
        if (s.service_count) metrics.push('<span class="category-meta-item">' + esc(pluralize(s.service_count, 'service', 'services')) + '</span>');
        if (s.specialist_count) metrics.push('<span class="category-meta-item">' + esc(pluralize(s.specialist_count, 'specialist', 'specialists')) + '</span>');
        if (s.industry_count) metrics.push('<span class="category-meta-item">' + esc(pluralize(s.industry_count, 'industry', 'industries')) + '</span>');
        if (s.country_count) metrics.push('<span class="category-meta-item">' + esc(pluralize(s.country_count, 'country', 'countries')) + '</span>');
        if (s.language_count) metrics.push('<span class="category-meta-item">' + esc(pluralize(s.language_count, 'language', 'languages')) + '</span>');
        return '<a href="' + url + '" class="category-card">' +
            '<div class="category-card-header">' +
            '<h3>' + esc(s.menu || s.title) + '</h3>' +
            iconHtml + '</div>' +
            '<p>' + esc(s.description) + '</p>' +
            (metrics.length ? '<div class="category-card-meta">' + metrics.join('') + '</div>' : '') +
            '<div class="category-card-footer">' +
            (price ? '<span class="category-price">From ' + price + '</span>' : '<span></span>') +
            '<span class="category-cta">Explore →</span></div></a>';
    }

    function renderSolutionCard(s) {
        var url = (s.url || '/solutions/' + s.slug).replace(/^\//, '');
        var f = s.facets || {};
        var tags = '';
        if (s.service) tags += '<span class="solution-tag">' + esc(label('services', s.service)) + '</span>';
        if (s.industry) tags += '<span class="solution-tag industry">' + esc(label('industries', s.industry)) + '</span>';
        var metrics = [];
        var specialistCount = Number(s.specialist_count || (f.specialists || []).length || 0);
        var caseCount = Number(s.case_count || (f.cases || []).length || 0);
        var countryCount = (f.countries || []).length;
        var languageCount = (f.languages || []).length;
        if (specialistCount > 0) metrics.push('<span class="solution-meta-item">' + esc(pluralize(specialistCount, 'specialist', 'specialists')) + '</span>');
        if (caseCount > 0) metrics.push('<span class="solution-meta-item">' + esc(pluralize(caseCount, 'case', 'cases')) + '</span>');
        if (countryCount > 0) metrics.push('<span class="solution-meta-item">' + esc(pluralize(countryCount, 'country', 'countries')) + '</span>');
        if (languageCount > 0) metrics.push('<span class="solution-meta-item">' + esc(pluralize(languageCount, 'language', 'languages')) + '</span>');
        var price = formatCurrency(s.starting_price);
        return '<a href="' + url + '" class="solution-card">' +
            (tags ? '<div class="solution-card-tags">' + tags + '</div>' : '') +
            '<h3>' + esc(s.menu || s.title) + '</h3><p>' + esc(s.description) + '</p>' +
            (metrics.length ? '<div class="solution-card-meta">' + metrics.join('') + '</div>' : '') +
            '<div class="solution-card-footer">' +
            (price ? '<span class="solution-price">From ' + price + '</span>' : '<span></span>') +
            '<span class="solution-cta">View Solution →</span></div></a>';
    }

    function renderDimensionCard(s, collection) {
        var url = (s.url || '/' + collection + '/' + s.slug).replace(/^\//, '');
        var badgeHtml = '';
        if (s.icon) {
            badgeHtml = '<div class="dimension-card-badge icon" style="--icon-url: url(/assets/icons/' + s.icon + '.svg)"></div>';
        } else if (s.flag) {
            badgeHtml = '<div class="dimension-card-badge">' + s.flag + '</div>';
        } else if (s.code) {
            badgeHtml = '<div class="dimension-card-badge code">' + esc(s.code) + '</div>';
        }
        var meta = [];
        if (collection === 'languages') {
            if (s.native_speakers_l1) meta.push('<span class="dimension-stat">Global native speakers: ' + esc(s.native_speakers_l1) + '</span>');
            if (s.official_countries_count) meta.push('<span class="dimension-stat">Official country footprint: ' + s.official_countries_count + '</span>');
        } else if (collection === 'countries') {
            if (s.population_total) meta.push('<span class="dimension-stat">Market population: ' + esc(s.population_total) + '</span>');
            if (s.official_languages_count) meta.push('<span class="dimension-stat">Official language coverage: ' + s.official_languages_count + '</span>');
        }
        var metaHtml = meta.length ? '<div class="dimension-card-meta">' + meta.join('') + '</div>' : '';
        var countText = s.service_count ? s.service_count + ' services' : '';
        return '<a href="' + url + '" class="dimension-card">' +
            '<div class="dimension-card-header">' +
            '<h3>' + esc(s.menu || s.title) + '</h3>' +
            badgeHtml + '</div>' +
            '<p>' + esc(s.description) + '</p>' +
            metaHtml +
            '<div class="dimension-card-footer">' +
            (countText ? '<span class="dimension-count">' + countText + '</span>' : '<span></span>') +
            '<span class="dimension-cta">Explore →</span></div></a>';
    }

    var RENDERERS = {
        services: renderServiceCard, team: renderSpecialistCard, cases: renderCaseCard, blog: renderBlogCard,
        categories: renderCategoryCard, solutions: renderSolutionCard,
        industries: function(s) { return renderDimensionCard(s, 'industries'); },
        countries: function(s) { return renderDimensionCard(s, 'countries'); },
        languages: function(s) { return renderDimensionCard(s, 'languages'); }
    };

    /* ===== Init sort dropdown ===== */
    cfg.sortOptions.forEach(function(opt) {
        var o = document.createElement('option');
        o.value = opt[0]; o.textContent = opt[1];
        sortEl.appendChild(o);
    });

    /* ===== Overflow trim for single-line tag rows ===== */
    function trimOverflowTags() {
        grid.querySelectorAll('.service-countries, .service-languages').forEach(function(row) {
            var children = Array.from(row.children);
            if (children.length <= 1 || row.scrollWidth <= row.clientWidth) return;
            var tagClass = children[0].className;
            var removed = 0;
            while (children.length > 0 && row.scrollWidth > row.clientWidth) {
                children.pop().remove();
                removed++;
            }
            if (removed > 0) {
                var more = document.createElement('span');
                more.className = tagClass;
                more.textContent = '+' + removed;
                more.style.flexShrink = '0';
                row.appendChild(more);
                while (row.children.length > 1 && row.scrollWidth > row.clientWidth) {
                    row.removeChild(row.children[row.children.length - 2]);
                    removed++;
                    more.textContent = '+' + removed;
                }
            }
        });
    }

    /* ===== Shared logic ===== */
    function renderGrid(items) {
        var render = RENDERERS[source] || RENDERERS.services;
        if (items.length === 0) {
            grid.innerHTML = '<div class="catalog-empty">No items match your criteria</div>';
        } else {
            grid.innerHTML = items.map(render).join('');
            trimOverflowTags();
        }
        countEl.textContent = items.length;
    }

    function getCheckedValues(filterName) {
        var dropdown = section.querySelector('[data-filter="' + filterName + '"]');
        if (!dropdown) return [];
        return Array.from(dropdown.querySelectorAll('input[type="checkbox"]:checked')).map(function(cb){ return cb.value; });
    }

    function updateDropdownText(dropdown) {
        var checked = dropdown.querySelectorAll('input[type="checkbox"]:checked');
        var textEl = dropdown.querySelector('.filter-selected-text');
        if (!textEl) return;
        if (checked.length === 0) textEl.textContent = textEl.dataset.all || 'All';
        else if (checked.length === 1) textEl.textContent = checked[0].nextElementSibling.textContent;
        else textEl.textContent = checked.length + ' selected';
    }

    function matchFilter(item, filterName) {
        var checked = getCheckedValues(filterName);
        if (checked.length === 0) return true;
        var facets = item.facets || {};
        var vals = facets[filterName] || item[filterName] || [];
        if (!Array.isArray(vals)) vals = [vals];
        var dropdown = section.querySelector('[data-filter="' + filterName + '"]');
        var matchMode = dropdown ? dropdown.dataset.match : '';
        if (matchMode === 'startsWith') {
            return checked.some(function(c){ return vals.some(function(v){ return String(v).indexOf(c) === 0; }); });
        }
        return checked.some(function(c){ return vals.indexOf(c) !== -1; });
    }

    function applyFilters() {
        var filtered = allItems.filter(function(item) {
            return activeFilters.every(function(f){ return matchFilter(item, f); });
        });
        return sortItems(filtered, sortEl.value);
    }

    function sortItems(items, by) {
        var sorted = items.slice();
        switch (by) {
            case 'rating': sorted.sort(function(a,b){ return (b.rating||0)-(a.rating||0); }); break;
            case 'projects': sorted.sort(function(a,b){ return (b.projects||0)-(a.projects||0); }); break;
            case 'name': sorted.sort(function(a,b){ return (a.title||'').localeCompare(b.title||''); }); break;
            case 'newest': sorted.sort(function(a,b){ return (b.date||'').localeCompare(a.date||''); }); break;
            case 'oldest': sorted.sort(function(a,b){ return (a.date||'').localeCompare(b.date||''); }); break;
            case 'popular': sorted.sort(function(a,b){ return (b.rating||0)-(a.rating||0); }); break;
            case 'services': sorted.sort(function(a,b){ return (b.service_count||0)-(a.service_count||0); }); break;
            case 'price': sorted.sort(function(a,b){ return (a.starting_price||9999)-(b.starting_price||9999); }); break;
            default: break;
        }
        return sorted;
    }

    /* ===== Init ===== */
    function init() {
        fetch(cfg.url)
            .then(function(res) { return res.ok ? res.json() : Promise.reject(); })
            .then(function(data) {
                LABELS = data.labels || {};
                allItems = cfg.dataKey ? (data[cfg.dataKey] || []) : (Array.isArray(data) ? data : []);
                renderGrid(applyFilters());
            })
            .catch(function() {
                grid.innerHTML = '<div class="catalog-empty">Could not load data.</div>';
            });

        sortEl.addEventListener('change', function() {
            renderGrid(applyFilters());
            window.dataLayer = window.dataLayer || [];
            window.dataLayer.push({event: 'sort_change', catalog_source: source, sort_by: sortEl.value});
        });

        /* Filter interactions (scoped to catalog section) */
        section.querySelectorAll('.filter-dropdown-toggle').forEach(function(btn) {
            btn.addEventListener('click', function(e) {
                e.stopPropagation();
                var dd = btn.closest('.filter-dropdown');
                var wasOpen = dd.classList.contains('open');
                section.querySelectorAll('.filter-dropdown').forEach(function(d){ d.classList.remove('open'); });
                if (!wasOpen) dd.classList.add('open');
            });
        });

        var filterState = 'none';
        var filterBtn = section.querySelector('.btn-apply-filters');

        function updateFilterBtn() {
            if (!filterBtn) return;
            var anyChecked = !!section.querySelector('.filter-dropdown input[type="checkbox"]:checked');
            if (!anyChecked) {
                filterBtn.classList.add('hidden');
            } else if (filterState === 'pending') {
                filterBtn.classList.remove('hidden');
                filterBtn.textContent = 'Apply Filters';
                filterBtn.className = 'btn btn-primary btn-sm btn-apply-filters';
            } else {
                filterBtn.classList.remove('hidden');
                filterBtn.textContent = 'Reset Filters';
                filterBtn.className = 'btn btn-secondary btn-sm btn-apply-filters';
            }
        }

        section.querySelectorAll('.filter-dropdown input[type="checkbox"]').forEach(function(cb) {
            cb.addEventListener('change', function() {
                updateDropdownText(cb.closest('.filter-dropdown'));
                var anyChecked = !!section.querySelector('.filter-dropdown input[type="checkbox"]:checked');
                if (anyChecked) {
                    filterState = 'pending';
                } else {
                    filterState = 'none';
                    renderGrid(applyFilters());
                }
                updateFilterBtn();
            });
        });

        document.addEventListener('click', function(e) {
            if (!e.target.closest('.filter-dropdown')) {
                section.querySelectorAll('.filter-dropdown').forEach(function(d){ d.classList.remove('open'); });
            }
        });

        if (filterBtn) {
            filterBtn.addEventListener('click', function() {
                if (filterState === 'pending') {
                    renderGrid(applyFilters());
                    filterState = 'applied';
                    var appliedFilters = {};
                    activeFilters.forEach(function(f) {
                        var vals = getCheckedValues(f);
                        if (vals.length) appliedFilters[f] = vals;
                    });
                    window.dataLayer = window.dataLayer || [];
                    window.dataLayer.push({event: 'filter_apply', catalog_source: source, filters: appliedFilters, result_count: allItems.filter(function(item) { return activeFilters.every(function(f){ return matchFilter(item, f); }); }).length});
                } else if (filterState === 'applied') {
                    section.querySelectorAll('.filter-dropdown input[type="checkbox"]').forEach(function(cb){ cb.checked = false; });
                    section.querySelectorAll('.filter-dropdown').forEach(function(dd){ updateDropdownText(dd); });
                    renderGrid(applyFilters());
                    filterState = 'none';
                }
                updateFilterBtn();
            });
        }
    }

    if (document.readyState === 'loading') document.addEventListener('DOMContentLoaded', init);
    else init();
})();
</script>
