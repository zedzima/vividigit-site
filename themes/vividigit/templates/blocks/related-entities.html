{# Related Entities Block â€” auto-generated from relationship graph #}
{% if data.sections %}
<div class="related-entities">
    {% for section in data.sections %}
    {% set section_items = section['items'] %}
    <section class="related-section" data-type="{{ section.type }}">
        <div class="related-section-header">
            <h2>{{ section.title }}</h2>
            {% if section_items | length > 4 %}
            <button class="related-show-all" data-expanded="false">
                Show all ({{ section_items | length }})
            </button>
            {% endif %}
        </div>
        <div class="related-grid{% if section_items | length > 4 %} related-grid-collapsed{% endif %}">
            {% for item in section_items %}
            {% set card_type = item.type | default('') %}
            {% if card_type == 'service' %}
                {% include 'blocks/cards/service-card.html' %}
            {% elif card_type == 'specialist' %}
                <div class="js-specialist-card" data-specialist='{{ item | tojson | forceescape }}'></div>
            {% elif card_type == 'case' %}
                {% include 'blocks/cards/case-card.html' %}
            {% elif card_type == 'solution' %}
                {% include 'blocks/cards/solution-card.html' %}
            {% elif card_type == 'blog-post' %}
                {% include 'blocks/cards/blog-post-card.html' %}
            {% elif card_type == 'category' %}
                {% include 'blocks/cards/category-card.html' %}
            {% else %}
                {% include 'blocks/cards/dimension-card.html' %}
            {% endif %}
            {% endfor %}
        </div>
    </section>
    {% endfor %}
</div>
<script>
(function() {
    var root = document.currentScript.previousElementSibling;
    if (!window.CMSCards || typeof window.CMSCards.renderSpecialistCard !== 'function') return;

    root.querySelectorAll('.js-specialist-card').forEach(function(node) {
        var raw = node.getAttribute('data-specialist');
        if (!raw) return;
        try {
            var specialist = JSON.parse(raw);
            node.outerHTML = window.CMSCards.renderSpecialistCard(specialist);
        } catch (e) {
            /* Keep placeholder unchanged if parsing fails */
        }
    });
})();
</script>
{% endif %}
