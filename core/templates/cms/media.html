{% extends "base.html" %}

{% block title %}Media Library{% endblock %}

{% block content %}
<div class="cms-flex-between cms-mb-lg">
    <h2>Media Library</h2>
    <button class="btn btn-primary" onclick="document.getElementById('file-input').click()">
        Upload File
    </button>
    <input type="file" id="file-input" class="cms-hidden" onchange="uploadFile(this)">
</div>

{% for folder, files in folders.items() %}
<div class="card cms-mb-md">
    <h3 class="cms-mb-md cms-text-muted">
        {{ folder if folder != 'root' else 'Root' }}
    </h3>
    <div class="cms-grid-thumbs">
        {% for file in files %}
        <div class="cms-text-center">
            {% if file.name.endswith(('.png', '.jpg', '.jpeg', '.gif', '.svg', '.webp')) %}
            <img src="{{ file.url }}" alt="{{ file.name }}" class="cms-media-thumb">
            {% else %}
            <div class="cms-media-placeholder">
                [file]
            </div>
            {% endif %}
            <div class="cms-media-name">
                {{ file.name }}
            </div>
        </div>
        {% endfor %}
    </div>
</div>
{% endfor %}

{% if not folders %}
<div class="card cms-text-center cms-text-muted">
    No media files. Upload some!
</div>
{% endif %}
{% endblock %}

{% block extra_js %}
<script>
async function uploadFile(input) {
    const file = input.files[0];
    if (!file) return;

    const formData = new FormData();
    formData.append('file', file);
    formData.append('folder', 'images/site');

    try {
        const response = await fetch('/admin/media/upload', {
            method: 'POST',
            body: formData
        });

        const result = await response.json();

        if (result.success) {
            showToast('Uploaded!', 'success');
            location.reload();
        } else {
            showToast(result.error, 'error');
        }
    } catch (err) {
        showToast('Error: ' + err.message, 'error');
    }

    input.value = '';
}
</script>
{% endblock %}
