{% extends "base.html" %}

{% block title %}New Page{% endblock %}

{% block content %}
<div class="cms-mb-lg">
    <a href="{{ url_for('admin_index') }}" class="cms-text-muted cms-no-underline">&larr; Back</a>
    <h2 class="cms-mt-xs">Create New Page</h2>
</div>

<div class="card">
    <div class="form-group">
        <label>URL Path</label>
        <div class="cms-flex-center cms-gap-sm">
            <span class="cms-text-muted">/</span>
            <input type="text" id="page-url" placeholder="services/new-service">
        </div>
    </div>

    <div class="form-group">
        <label>Page Title</label>
        <input type="text" id="page-title" placeholder="New Service Page">
    </div>
</div>

<div class="cms-section-gap">
    <h3>Select Blocks</h3>
    <p class="cms-text-muted cms-text-sm">Choose which blocks to include</p>
</div>

<div class="cms-grid-blocks">
    {% for block in blocks %}
    <label class="card cms-block-label">
        <input type="checkbox" name="blocks" value="{{ block.name }}">
        <span>{{ block.name }}</span>
    </label>
    {% endfor %}
</div>

<div class="cms-mt-lg">
    <button class="btn btn-primary" onclick="createPage()">Create Page</button>
</div>
{% endblock %}

{% block extra_js %}
<script>
async function createPage() {
    const url = document.getElementById('page-url').value;
    const title = document.getElementById('page-title').value;
    const blocks = Array.from(document.querySelectorAll('[name="blocks"]:checked'))
        .map(cb => cb.value);

    if (!url) {
        showToast('URL is required', 'error');
        return;
    }

    if (!title) {
        showToast('Title is required', 'error');
        return;
    }

    try {
        const response = await fetch('/admin/pages/create', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ url, title, blocks })
        });

        const result = await response.json();

        if (result.success) {
            showToast('Page created!', 'success');
            window.location.href = result.url;
        } else {
            showToast(result.error, 'error');
        }
    } catch (err) {
        showToast('Error: ' + err.message, 'error');
    }
}
</script>
{% endblock %}
